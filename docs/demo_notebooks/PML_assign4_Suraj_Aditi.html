<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Assignment 4 PML – Suraj Jaiswal</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-07ba0ad10f5680c660e360ac31d2f3b6.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-8bda806db8b623a4dafb352339cca83f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Suraj Jaiswal</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../blogs/index.html"> 
<span class="menu-text">Blogs</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../publications_and_projects/index.html"> 
<span class="menu-text">Publications and Projects</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../resume/Suraj_Jaiswal_Resume.pdf"> 
<span class="menu-text">Resume</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#question-1" id="toc-question-1" class="nav-link active" data-scroll-target="#question-1">Question 1:</a></li>
  <li><a href="#question-2" id="toc-question-2" class="nav-link" data-scroll-target="#question-2">Question 2:</a>
  <ul class="collapse">
  <li><a href="#pooled-model" id="toc-pooled-model" class="nav-link" data-scroll-target="#pooled-model">Pooled model</a></li>
  <li><a href="#hierarchical-model" id="toc-hierarchical-model" class="nav-link" data-scroll-target="#hierarchical-model">Hierarchical model</a></li>
  <li><a href="#hierarchical-model-1" id="toc-hierarchical-model-1" class="nav-link" data-scroll-target="#hierarchical-model-1">Hierarchical model</a></li>
  </ul></li>
  <li><a href="#question-3" id="toc-question-3" class="nav-link" data-scroll-target="#question-3">Question 3</a>
  <ul class="collapse">
  <li><a href="#hyper-network" id="toc-hyper-network" class="nav-link" data-scroll-target="#hyper-network">Hyper Network</a>
  <ul class="collapse">
  <li><a href="#prepare-data" id="toc-prepare-data" class="nav-link" data-scroll-target="#prepare-data">prepare data</a></li>
  <li><a href="#extras" id="toc-extras" class="nav-link" data-scroll-target="#extras">Extras</a></li>
  <li><a href="#loading-and-preprocessing" id="toc-loading-and-preprocessing" class="nav-link" data-scroll-target="#loading-and-preprocessing">loading and preprocessing</a></li>
  <li><a href="#model-defination" id="toc-model-defination" class="nav-link" data-scroll-target="#model-defination">model defination</a></li>
  <li><a href="#initialize-the-model-and-input" id="toc-initialize-the-model-and-input" class="nav-link" data-scroll-target="#initialize-the-model-and-input">Initialize the model and input</a></li>
  <li><a href="#training-loop" id="toc-training-loop" class="nav-link" data-scroll-target="#training-loop">Training loop</a></li>
  <li><a href="#saving-and-loading-the-model" id="toc-saving-and-loading-the-model" class="nav-link" data-scroll-target="#saving-and-loading-the-model">saving and loading the model</a></li>
  <li><a href="#plots" id="toc-plots" class="nav-link" data-scroll-target="#plots">Plots</a></li>
  </ul></li>
  <li><a href="#neural-processes" id="toc-neural-processes" class="nav-link" data-scroll-target="#neural-processes">Neural Processes</a>
  <ul class="collapse">
  <li><a href="#loading-and-preprocessing-1" id="toc-loading-and-preprocessing-1" class="nav-link" data-scroll-target="#loading-and-preprocessing-1">loading and preprocessing</a></li>
  <li><a href="#training-loop-1" id="toc-training-loop-1" class="nav-link" data-scroll-target="#training-loop-1">Training loop</a></li>
  <li><a href="#saving-and-loading-the-model-1" id="toc-saving-and-loading-the-model-1" class="nav-link" data-scroll-target="#saving-and-loading-the-model-1">saving and loading the model</a></li>
  <li><a href="#plots-1" id="toc-plots-1" class="nav-link" data-scroll-target="#plots-1">Plots</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#question-4." id="toc-question-4." class="nav-link" data-scroll-target="#question-4.">Question 4.</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Assignment 4 PML</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="question-1" class="level2">
<h2 class="anchored" data-anchor-id="question-1">Question 1:</h2>
<p>Implement Logistic Regression using the Pyro library referring [1] for guidance. Show both the mean prediction as well as standard deviation in the predictions over the 2d grid. Use NUTS MCMC sampling to sample the posterior. Take 1000 samples for posterior distribution and use 500 samples as burn/warm up. Use the below given dataset.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.datasets <span class="im">import</span> make_moons</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>X, y <span class="op">=</span> make_moons(n_samples<span class="op">=</span><span class="dv">100</span>, noise<span class="op">=</span><span class="fl">0.3</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y,test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="cell-3" class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> jax <span class="im">import</span> random</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>sns.set_context(<span class="st">"notebook"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-4" class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> numpyro</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip install numpyro</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> numpyro</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-5" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> pyro</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span>pip install pyro<span class="op">-</span>ppl</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> pyro</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-6" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pyro.distributions <span class="im">as</span> dist</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-7" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyro.infer <span class="im">import</span> MCMC, NUTS, Predictive</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-8" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.datasets <span class="im">import</span> make_moons</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>X, y <span class="op">=</span> make_moons(n_samples<span class="op">=</span><span class="dv">100</span>, noise<span class="op">=</span><span class="fl">0.3</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y,test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-9" class="cell" data-outputid="dc4f3f7e-f9cf-451c-ba40-560c97d3f15d">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> torch.tensor(X_train).<span class="bu">float</span>()</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> torch.tensor(y_train).<span class="bu">float</span>()</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> torch.tensor(X_test).<span class="bu">float</span>()</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> torch.tensor(y_test).<span class="bu">float</span>()</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>X_train.shape, y_train.shape,X_test.shape, y_test.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>(torch.Size([80, 2]), torch.Size([80]), torch.Size([20, 2]), torch.Size([20]))</code></pre>
</div>
</div>
<div id="cell-10" class="cell" data-outputid="c9f883d6-10e4-4d46-a7ce-6a863d74ab0c">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Separate data points by class</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>class_0 <span class="op">=</span> X[y <span class="op">==</span> <span class="dv">0</span>]</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>class_1 <span class="op">=</span> X[y <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a scatter plot</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>plt.scatter(class_0[:, <span class="dv">0</span>], class_0[:, <span class="dv">1</span>], label<span class="op">=</span><span class="st">"Class 0"</span>, marker<span class="op">=</span><span class="st">'o'</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>plt.scatter(class_1[:, <span class="dv">0</span>], class_1[:, <span class="dv">1</span>], label<span class="op">=</span><span class="st">"Class 1"</span>, marker<span class="op">=</span><span class="st">'o'</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Feature 1"</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Feature 2"</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Generated Moons Dataset"</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-9-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-11" class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> logistic_model(X, y):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sample from prior</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> pyro.sample(</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">'w'</span>, dist.Normal(torch.zeros(X.shape[<span class="dv">1</span>]), torch.ones(X.shape[<span class="dv">1</span>]))</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    b <span class="op">=</span> pyro.sample(</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">'b'</span>, dist.Normal(torch.zeros(<span class="dv">1</span>), torch.ones(<span class="dv">1</span>))</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> pyro.iarange(<span class="st">'data'</span>, X.shape[<span class="dv">0</span>]):</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        model_logits <span class="op">=</span> torch.matmul(X, w) <span class="op">+</span> b</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>        pyro.sample(<span class="st">'obs'</span>, dist.Bernoulli(logits<span class="op">=</span>model_logits), obs<span class="op">=</span>y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-12" class="cell" data-outputid="2bbfa5a8-3950-4096-b5d4-fea9a060ea39">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>nuts_kernel <span class="op">=</span> NUTS(logistic_model, adapt_step_size<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>mcmc <span class="op">=</span> MCMC(nuts_kernel, num_samples<span class="op">=</span><span class="dv">1000</span>, warmup_steps<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>mcmc.run(X_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warmup:   0%|          | 3/1500 [00:00, 25.77it/s, step size=1.20e-01, acc. prob=0.333]Sample: 100%|██████████| 1500/1500 [00:32, 46.05it/s, step size=6.50e-01, acc. prob=0.929] </code></pre>
</div>
</div>
<div id="cell-13" class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>posterior_samples <span class="op">=</span> mcmc.get_samples()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-14" class="cell" data-outputid="950d9863-73c6-4f59-9cfc-2d463121ae87">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arviz <span class="im">as</span> az</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>idata <span class="op">=</span> az.from_pyro(mcmc)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>az.plot_trace(idata, compact<span class="op">=</span><span class="va">True</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>c:\Users\Dell\AppData\Local\Programs\Python\Python311\Lib\site-packages\arviz\data\io_pyro.py:157: UserWarning: Could not get vectorized trace, log_likelihood group will be omitted. Check your model vectorization or set log_likelihood=False
  warnings.warn(</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-13-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-13-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-15" class="cell" data-outputid="caff395b-f4dd-45b2-9889-8b5c2fee5c9a">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>posterior_samples[<span class="st">'w'</span>].mean(<span class="dv">0</span>), posterior_samples[<span class="st">'b'</span>].mean(<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>(tensor([ 1.1069, -2.0874]), tensor([0.1179]))</code></pre>
</div>
</div>
<div id="cell-16" class="cell" data-outputid="d3b3d22f-ad10-448b-f14d-cbc897e3ce8f">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>posterior_samples[<span class="st">'w'</span>].std(<span class="dv">0</span>), posterior_samples[<span class="st">'b'</span>].std(<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>(tensor([0.3259, 0.5515]), tensor([0.3369]))</code></pre>
</div>
</div>
<div id="cell-17" class="cell" data-outputid="11d89fe3-8491-417b-c6df-fbd885cc15bf">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a function to plot the decision boundary</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_decision_boundary(X, y, posterior_samples, title<span class="op">=</span><span class="st">"Posterior Decision Boundary"</span>):</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a meshgrid of points for the entire feature space</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    x_min, x_max <span class="op">=</span> X[:, <span class="dv">0</span>].<span class="bu">min</span>() <span class="op">-</span> <span class="fl">0.1</span>, X[:, <span class="dv">0</span>].<span class="bu">max</span>() <span class="op">+</span> <span class="fl">0.1</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    y_min, y_max <span class="op">=</span> X[:, <span class="dv">1</span>].<span class="bu">min</span>() <span class="op">-</span> <span class="fl">0.1</span>, X[:, <span class="dv">1</span>].<span class="bu">max</span>() <span class="op">+</span> <span class="fl">0.1</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    xx, yy <span class="op">=</span> torch.meshgrid(torch.linspace(x_min, x_max, <span class="dv">100</span>), torch.linspace(y_min, y_max, <span class="dv">100</span>))</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Flatten the meshgrid for prediction</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    grid <span class="op">=</span> torch.cat((xx.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>), yy.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)), dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get the number of posterior samples</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    num_samples <span class="op">=</span> <span class="bu">len</span>(posterior_samples[<span class="st">'w'</span>])</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot the posterior decision boundary for each sample</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(num_samples):</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>        w <span class="op">=</span> posterior_samples[<span class="st">'w'</span>][i]</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>        b <span class="op">=</span> posterior_samples[<span class="st">'b'</span>][i]</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate the logits and probabilities</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>        logits <span class="op">=</span> torch.matmul(grid, w) <span class="op">+</span> b</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>        probs <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> torch.exp(<span class="op">-</span>logits))</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>        probs <span class="op">=</span> probs.detach().numpy().reshape(xx.shape)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot the decision boundary</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># plt.contourf(xx, yy, probs, levels=[0, 0.5, 1], alpha=0.2, cmap=plt.cm.RdBu)</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>        plt.contourf(xx, yy, probs, <span class="dv">10</span>, cmap<span class="op">=</span>plt.cm.RdBu)</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot the data points</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    plt.scatter(X[y <span class="op">==</span> <span class="dv">0</span>][:, <span class="dv">0</span>], X[y <span class="op">==</span> <span class="dv">0</span>][:, <span class="dv">1</span>], label<span class="op">=</span><span class="st">"Class 0"</span>, marker<span class="op">=</span><span class="st">'o'</span>, color <span class="op">=</span> <span class="st">'r'</span>)</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    plt.scatter(X[y <span class="op">==</span> <span class="dv">1</span>][:, <span class="dv">0</span>], X[y <span class="op">==</span> <span class="dv">1</span>][:, <span class="dv">1</span>], label<span class="op">=</span><span class="st">"Class 1"</span>, marker<span class="op">=</span><span class="st">'o'</span>, color <span class="op">=</span> <span class="st">'b'</span>)</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"Feature 1"</span>)</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"Feature 2"</span>)</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>    plt.title(title)</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the decision boundary on the test data</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>plot_decision_boundary(X_test, y_test, posterior_samples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-16-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="question-2" class="level2">
<h2 class="anchored" data-anchor-id="question-2">Question 2:</h2>
<p>Consider the FVC dataset example discussed in the class. Find the notebook link at [2]. We had only used the train dataset. Now, we want to find out the performance of various models on the test dataset. Use the given dataset and deduce which model works best in terms of error (MAE) and coverage? The base model is Linear Regression by Sklearn (from sklearn.linear_model import LinearRegression). Plot the trace diagrams and posterior distribution. Also plot the predictive posterior distribution with 90% confidence interval.</p>
<div id="cell-19" class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>URL <span class="op">=</span> <span class="st">"https://gist.githubusercontent.com/ucals/"</span> <span class="op">+</span> <span class="st">"2cf9d101992cb1b78c2cdd6e3bac6a4b/raw/"</span><span class="op">+</span> <span class="st">"43034c39052dcf97d4b894d2ec1bc3f90f3623d9/"</span><span class="op">+</span> <span class="st">"osic_pulmonary_fibrosis.csv"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-20" class="cell" data-outputid="91adc3ea-9174-4354-a7a4-32575b44f328">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(URL)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Patient</th>
<th data-quarto-table-cell-role="th">Weeks</th>
<th data-quarto-table-cell-role="th">FVC</th>
<th data-quarto-table-cell-role="th">Percent</th>
<th data-quarto-table-cell-role="th">Age</th>
<th data-quarto-table-cell-role="th">Sex</th>
<th data-quarto-table-cell-role="th">SmokingStatus</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>ID00007637202177411956430</td>
<td>-4</td>
<td>2315</td>
<td>58.253649</td>
<td>79</td>
<td>Male</td>
<td>Ex-smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>ID00007637202177411956430</td>
<td>5</td>
<td>2214</td>
<td>55.712129</td>
<td>79</td>
<td>Male</td>
<td>Ex-smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>ID00007637202177411956430</td>
<td>7</td>
<td>2061</td>
<td>51.862104</td>
<td>79</td>
<td>Male</td>
<td>Ex-smoker</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>ID00007637202177411956430</td>
<td>9</td>
<td>2144</td>
<td>53.950679</td>
<td>79</td>
<td>Male</td>
<td>Ex-smoker</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>ID00007637202177411956430</td>
<td>11</td>
<td>2069</td>
<td>52.063412</td>
<td>79</td>
<td>Male</td>
<td>Ex-smoker</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-21" class="cell" data-outputid="ac364f1d-da47-4c8e-e715-2411cd168e34">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>x_train, x_test, y_train, y_test <span class="op">=</span> train_test_split(df[<span class="st">"Weeks"</span>], df[<span class="st">'FVC'</span>], train_size <span class="op">=</span> <span class="fl">0.8</span>, random_state <span class="op">=</span> <span class="dv">0</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Training set shape: </span><span class="sc">{</span>x_train<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Testing set shape: </span><span class="sc">{</span>x_test<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Training set shape: (1239,)
Testing set shape: (310,)</code></pre>
</div>
</div>
<div id="cell-22" class="cell" data-outputid="b4619c90-5e02-42d4-a42c-0bba577436e2">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">### Linear regression from scikit-learn</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> LinearRegression()</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>lr.fit(x_train.values.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>), y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<style>#sk-container-id-1 {color: black;background-color: white;}#sk-container-id-1 pre{padding: 0;}#sk-container-id-1 div.sk-toggleable {background-color: white;}#sk-container-id-1 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-1 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-1 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-1 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-1 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-1 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-1 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-1 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-1 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-1 div.sk-item {position: relative;z-index: 1;}#sk-container-id-1 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-1 div.sk-item::before, #sk-container-id-1 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-1 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-1 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-1 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-1 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-1 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-1 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-1 div.sk-label-container {text-align: center;}#sk-container-id-1 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-1 div.sk-text-repr-fallback {display: none;}</style><div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>LinearRegression()</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item"><div class="sk-estimator sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox" checked=""><label for="sk-estimator-id-1" class="sk-toggleable__label sk-toggleable__label-arrow">LinearRegression</label><div class="sk-toggleable__content"><pre>LinearRegression()</pre></div></div></div></div></div>
</div>
</div>
<div id="cell-23" class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>all_weeks <span class="op">=</span> np.arange(<span class="op">-</span><span class="dv">12</span>, <span class="dv">134</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-24" class="cell" data-outputid="5d82a789-ccd1-4294-a541-9768a4c017ec">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the data and the regression line</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>plt.scatter(x_test.values.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>), y_test, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>plt.plot(x_test, lr.predict(x_test.values.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>)), color<span class="op">=</span><span class="st">"black"</span>, lw<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Weeks"</span>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"FVC"</span>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Linear Regression predictions on test data"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>Text(0.5, 1.0, 'Linear Regression predictions on test data')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-22-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-4"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-22-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Prediction: Vanilla LR</p>
<div id="cell-26" class="cell" data-outputid="c7c1344f-c3e8-47ab-f8ec-23800f8e0cf0">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> lr.predict(x_test.values.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_absolute_error</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>maes <span class="op">=</span> {}</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>maes[<span class="st">"LinearRegression"</span>] <span class="op">=</span> mean_absolute_error(y_test.values, predictions)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>maes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>{'LinearRegression': 626.3184730275215}</code></pre>
</div>
</div>
<section id="pooled-model" class="level3">
<h3 class="anchored" data-anchor-id="pooled-model">Pooled model</h3>
<p><span class="math inline">\(\alpha \sim \text{Normal}(0, 500)\)</span></p>
<p><span class="math inline">\(\beta \sim \text{Normal}(0, 500)\)</span></p>
<p><span class="math inline">\(\sigma \sim \text{HalfNormal}(100)\)</span></p>
<p><code>for i in range(N_Weeks):</code></p>
<p><span class="math inline">\(FVC_i \sim \text{Normal}(\alpha + \beta \cdot Week_i, \sigma)\)</span></p>
<div id="cell-28" class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pooled_model(X, y<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    α <span class="op">=</span> numpyro.sample(<span class="st">"α"</span>, dist.Normal(<span class="fl">0.</span>, <span class="fl">500.</span>))</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    β <span class="op">=</span> numpyro.sample(<span class="st">"β"</span>, dist.Normal(<span class="fl">0.</span>, <span class="fl">500.</span>))</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    σ <span class="op">=</span> numpyro.sample(<span class="st">"σ"</span>, dist.HalfNormal(<span class="fl">50.</span>))</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> numpyro.plate(<span class="st">"samples"</span>, <span class="bu">len</span>(X)):</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>        fvc <span class="op">=</span> numpyro.sample(<span class="st">"fvc"</span>, dist.Normal(α <span class="op">+</span> β <span class="op">*</span> X, σ), obs<span class="op">=</span>y)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fvc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-29" class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpyro.distributions <span class="im">as</span> dist</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-30" class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> LabelEncoder</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>patient_encoder <span class="op">=</span> LabelEncoder()</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"patient_code"</span>] <span class="op">=</span> patient_encoder.fit_transform(df[<span class="st">"Patient"</span>].values)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-31" class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>sample_patient_code_train <span class="op">=</span> df[<span class="st">"patient_code"</span>].values[x_train.index]</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>sample_patient_code_test <span class="op">=</span> df[<span class="st">"patient_code"</span>].values[x_test.index]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-32" class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpyro.infer <span class="im">import</span> MCMC, NUTS, Predictive</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-33" class="cell" data-outputid="5775a243-2650-4f56-a85c-9d155c97f6a5">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>nuts_kernel <span class="op">=</span> NUTS(pooled_model)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>mcmc <span class="op">=</span> MCMC(nuts_kernel, num_samples<span class="op">=</span><span class="dv">4000</span>, num_warmup<span class="op">=</span><span class="dv">2000</span>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>rng_key <span class="op">=</span> random.PRNGKey(<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>No GPU/TPU found, falling back to CPU. (Set TF_CPP_MIN_LOG_LEVEL=0 and rerun for more info.)</code></pre>
</div>
</div>
<div id="cell-34" class="cell" data-outputid="3c622435-37ef-4ba4-d4dd-f76bea6db3f2">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>x_train.values.reshape(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>).shape, y_train.values.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>((1239, 1), (1239,))</code></pre>
</div>
</div>
<div id="cell-35" class="cell" data-outputid="658256de-fa5e-4ca0-a8c2-24041e3f010c">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>mcmc.run(rng_key, X<span class="op">=</span>x_train.values, y<span class="op">=</span>y_train.values)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>posterior_samples <span class="op">=</span> mcmc.get_samples()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>sample: 100%|██████████| 6000/6000 [00:07&lt;00:00, 780.32it/s, 15 steps of size 4.41e-01. acc. prob=0.93] </code></pre>
</div>
</div>
<div id="cell-36" class="cell" data-outputid="dbc44da6-abce-4a8c-be52-87bbadee263a">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> arviz <span class="im">as</span> az</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>idata <span class="op">=</span> az.from_numpyro(mcmc)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>az.plot_trace(idata, compact<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>array([[&lt;Axes: title={'center': 'α'}&gt;, &lt;Axes: title={'center': 'α'}&gt;],
       [&lt;Axes: title={'center': 'β'}&gt;, &lt;Axes: title={'center': 'β'}&gt;],
       [&lt;Axes: title={'center': 'σ'}&gt;, &lt;Axes: title={'center': 'σ'}&gt;]],
      dtype=object)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-32-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-5"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-32-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-37" class="cell" data-outputid="e88f89ea-3c16-4d6a-87a9-73789b12f918">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>az.summary(idata, round_to<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>arviz - WARNING - Shape validation failed: input_shape: (1, 4000), minimum_shape: (chains=2, draws=4)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="24">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">sd</th>
<th data-quarto-table-cell-role="th">hdi_3%</th>
<th data-quarto-table-cell-role="th">hdi_97%</th>
<th data-quarto-table-cell-role="th">mcse_mean</th>
<th data-quarto-table-cell-role="th">mcse_sd</th>
<th data-quarto-table-cell-role="th">ess_bulk</th>
<th data-quarto-table-cell-role="th">ess_tail</th>
<th data-quarto-table-cell-role="th">r_hat</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">α</td>
<td>2732.55</td>
<td>36.72</td>
<td>2666.72</td>
<td>2804.27</td>
<td>0.86</td>
<td>0.61</td>
<td>1831.78</td>
<td>2063.36</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">β</td>
<td>-1.37</td>
<td>0.92</td>
<td>-3.15</td>
<td>0.25</td>
<td>0.02</td>
<td>0.02</td>
<td>1918.32</td>
<td>2020.37</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">σ</td>
<td>773.88</td>
<td>12.85</td>
<td>749.97</td>
<td>798.30</td>
<td>0.25</td>
<td>0.18</td>
<td>2569.03</td>
<td>1991.23</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-38" class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictive distribution</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>predictive <span class="op">=</span> Predictive(pooled_model, mcmc.get_samples())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-39" class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> predictive(rng_key, x_test.values, <span class="va">None</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-40" class="cell" data-outputid="3a23b4e1-af9d-45b1-8751-494fe1ac9ff0">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(predictions[<span class="st">"fvc"</span>]).mean().plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-36-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-6"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-36-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-41" class="cell" data-outputid="65fa592b-7119-4621-f2b5-e30eb089d9b9">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>plt.plot(x_test, predictions[<span class="st">"fvc"</span>].mean(axis<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>plt.scatter(x_test, y_test, alpha<span class="op">=</span><span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-37-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-7"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-37-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-42" class="cell" data-outputid="a13c5f94-0f0a-47cc-dc71-1a117457cdbf">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the mean and standard deviation of the predictions</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>mu <span class="op">=</span> predictions[<span class="st">"fvc"</span>].mean(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>sigma <span class="op">=</span> predictions[<span class="st">"fvc"</span>].std(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the predictions</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>plt.plot(x_test, mu)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>plt.fill_between(x_test, mu <span class="op">-</span> <span class="fl">1.64</span><span class="op">*</span>sigma, mu <span class="op">+</span> <span class="fl">1.64</span><span class="op">*</span>sigma, alpha<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>plt.scatter(x_test, y_test, alpha<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Weeks"</span>)</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"FVC"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>Text(0, 0.5, 'FVC')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-38-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-8"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-38-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-43" class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>preds_pooled  <span class="op">=</span> predictive(rng_key, x_test.values, <span class="va">None</span>)[<span class="st">'fvc'</span>]</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>predictions_train_pooled <span class="op">=</span> preds_pooled.mean(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>std_train_pooled <span class="op">=</span> preds_pooled.std(axis<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-44" class="cell" data-outputid="77e3744f-f9b9-463e-c6da-d633c27e0c6c">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co">### Computing Mean Absolute Error and Coverage at 95% confidence interval</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>maes[<span class="st">"PooledModel"</span>] <span class="op">=</span> mean_absolute_error(y_test, predictions_train_pooled)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>maes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>{'LinearRegression': 626.3184730275215, 'PooledModel': 626.4611966040827}</code></pre>
</div>
</div>
<div id="cell-45" class="cell" data-outputid="cceecd68-309d-4ed9-fd4b-bbc4bbead77e">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co">### Computing the coverage at 95% confidence interval</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> coverage(y_true, y_pred, sigma):</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    lower <span class="op">=</span> y_pred <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> sigma</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    upper <span class="op">=</span> y_pred <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> sigma</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.mean((y_true <span class="op">&gt;=</span> lower) <span class="op">&amp;</span> (y_true <span class="op">&lt;=</span> upper))</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>coverages <span class="op">=</span> {}</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>coverages[<span class="st">"pooled"</span>] <span class="op">=</span> coverage(y_test, predictions_train_pooled, std_train_pooled).item()</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>coverages</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>{'pooled': 0.9483870967741935}</code></pre>
</div>
</div>
</section>
<section id="hierarchical-model" class="level3">
<h3 class="anchored" data-anchor-id="hierarchical-model">Hierarchical model</h3>
<p><span class="math inline">\(\sigma \sim \text{HalfNormal}(100)\)</span></p>
<hr>
<p><span class="math inline">\(\mu_{\alpha} \sim \text{Normal}(0, 500)\)</span></p>
<p><span class="math inline">\(\sigma_{\alpha} \sim \text{HalfNormal}(100)\)</span></p>
<p><span class="math inline">\(\mu_{\beta} \sim \text{Normal}(0, 500)\)</span></p>
<p><span class="math inline">\(\sigma_{\beta} \sim \text{HalfNormal}(100)\)</span></p>
<hr>
<p><code>for p in range(N_patients):</code></p>
<p><span class="math inline">\(\alpha_p \sim \text{Normal}(\mu_{\alpha}, \sigma_{\alpha})\)</span></p>
<p><span class="math inline">\(\beta_p \sim \text{Normal}(\mu_{\beta}, \sigma_{\beta})\)</span></p>
<hr>
<p><code>for i in range(N_Weeks):</code></p>
<p><span class="math inline">\(FVC_i \sim \text{Normal}(\alpha_{p[i]} + \beta_{p[i]} \cdot Week_i, \sigma)\)</span></p>
<div id="cell-47" class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co">### Hierarchical model</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> partial_pool_same_sigma(sample_weeks, sample_patient_code, sample_fvc<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    μ_α <span class="op">=</span> numpyro.sample(<span class="st">"μ_α"</span>, dist.Normal(<span class="fl">0.0</span>, <span class="fl">500.0</span>))</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    σ_α <span class="op">=</span> numpyro.sample(<span class="st">"σ_α"</span>, dist.HalfNormal(<span class="fl">100.0</span>))</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    μ_β <span class="op">=</span> numpyro.sample(<span class="st">"μ_β"</span>, dist.Normal(<span class="fl">0.0</span>, <span class="fl">3.0</span>))</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    σ_β <span class="op">=</span> numpyro.sample(<span class="st">"σ_β"</span>, dist.HalfNormal(<span class="fl">3.0</span>))</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    n_patients <span class="op">=</span> <span class="bu">len</span>(np.unique(sample_patient_code))</span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> numpyro.plate(<span class="st">"Participants"</span>, n_patients):</span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>        α <span class="op">=</span> numpyro.sample(<span class="st">"α"</span>, dist.Normal(μ_α, σ_α))</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>        β <span class="op">=</span> numpyro.sample(<span class="st">"β"</span>, dist.Normal(μ_β, σ_β))</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>    σ <span class="op">=</span> numpyro.sample(<span class="st">"σ"</span>, dist.HalfNormal(<span class="fl">100.0</span>))</span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>    FVC_est <span class="op">=</span> α[sample_patient_code] <span class="op">+</span> β[sample_patient_code] <span class="op">*</span> sample_weeks</span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> numpyro.plate(<span class="st">"data"</span>, <span class="bu">len</span>(sample_patient_code)):</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>        numpyro.sample(<span class="st">"fvc"</span>, dist.Normal(FVC_est, σ), obs<span class="op">=</span>sample_fvc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-48" class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>nuts_ppss <span class="op">=</span> NUTS(partial_pool_same_sigma)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>mcmc_ppss <span class="op">=</span> MCMC(nuts_ppss, num_samples<span class="op">=</span><span class="dv">4000</span>, num_warmup<span class="op">=</span><span class="dv">2000</span>)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>rng_key <span class="op">=</span> random.PRNGKey(<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-49" class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>model_kwargs <span class="op">=</span> {<span class="st">"sample_weeks"</span>: x_train.values,</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>                <span class="st">"sample_patient_code"</span>: sample_patient_code_train,</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>                <span class="st">"sample_fvc"</span>:y_train.values}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-50" class="cell" data-outputid="ef2adeaf-3eaa-4372-e587-7a88351265f5">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>mcmc_ppss.run(rng_key, <span class="op">**</span>model_kwargs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>sample: 100%|██████████| 6000/6000 [01:28&lt;00:00, 67.52it/s, 63 steps of size 1.26e-02. acc. prob=0.85]  </code></pre>
</div>
</div>
<div id="cell-51" class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>predictive_ppss <span class="op">=</span> Predictive(partial_pool_same_sigma, mcmc_ppss.get_samples())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-52" class="cell" data-outputid="a04fd70c-9aee-4b34-ccee-e3287a7ca3b1">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>az.plot_trace(az.from_numpyro(mcmc_ppss), compact<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>array([[&lt;Axes: title={'center': 'α'}&gt;, &lt;Axes: title={'center': 'α'}&gt;],
       [&lt;Axes: title={'center': 'β'}&gt;, &lt;Axes: title={'center': 'β'}&gt;],
       [&lt;Axes: title={'center': 'μ_α'}&gt;, &lt;Axes: title={'center': 'μ_α'}&gt;],
       [&lt;Axes: title={'center': 'μ_β'}&gt;, &lt;Axes: title={'center': 'μ_β'}&gt;],
       [&lt;Axes: title={'center': 'σ'}&gt;, &lt;Axes: title={'center': 'σ'}&gt;],
       [&lt;Axes: title={'center': 'σ_α'}&gt;, &lt;Axes: title={'center': 'σ_α'}&gt;],
       [&lt;Axes: title={'center': 'σ_β'}&gt;, &lt;Axes: title={'center': 'σ_β'}&gt;]],
      dtype=object)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-47-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-9"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-47-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-53" class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>predictive_ppss <span class="op">=</span> Predictive(partial_pool_same_sigma, mcmc_ppss.get_samples())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-54" class="cell" data-outputid="00de17b5-1a6c-4671-cda7-67c55eb55e23">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>predictions_test_ppss <span class="op">=</span> predictive_ppss(rng_key,</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>                                                         sample_weeks <span class="op">=</span> x_test.values,</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>                                                         sample_patient_code <span class="op">=</span> sample_patient_code_test)[<span class="st">'fvc'</span>]</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>mu_predictions_test_h <span class="op">=</span> predictions_test_ppss.mean(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>std_predictions_test_h <span class="op">=</span> predictions_test_ppss.std(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>maes[<span class="st">"PatrialPooled_samesigma"</span>] <span class="op">=</span> mean_absolute_error(y_test, mu_predictions_test_h)</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>coverages[<span class="st">"PatrialPooled_samesigma"</span>] <span class="op">=</span> coverage(y_test, mu_predictions_test_h, std_predictions_test_h).item()</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(maes)</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(coverages)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'LinearRegression': 626.3184730275215, 'PooledModel': 626.4611966040827, 'PatrialPooled_samesigma': 110.46457322643649}
{'pooled': 0.9483870967741935, 'PatrialPooled_samesigma': 0.9419354838709677}</code></pre>
</div>
</div>
<div id="cell-55" class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict for a given patient</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_ppss(patient_code):</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> predictive_ppss(rng_key, all_weeks, patient_code)</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> predictions[<span class="st">"fvc"</span>].mean(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">=</span> predictions[<span class="st">"fvc"</span>].std(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mu, sigma</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the predictions for a given patient</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_patient_ppss(patient_code):</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>    mu, sigma <span class="op">=</span> predict_ppss(patient_code)</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a>    plt.scatter(all_weeks, mu)</span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>    plt.fill_between(all_weeks, mu <span class="op">-</span> <span class="fl">1.64</span><span class="op">*</span>sigma, mu <span class="op">+</span> <span class="fl">1.64</span><span class="op">*</span>sigma, alpha<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>    id_to_patient <span class="op">=</span> patient_encoder.inverse_transform([patient_code])[<span class="dv">0</span>]</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>    patient_weeks <span class="op">=</span> x_test.values[sample_patient_code_test <span class="op">==</span> patient_code]</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>    patient_fvc <span class="op">=</span> y_test.values[sample_patient_code_test <span class="op">==</span> patient_code]</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>    plt.scatter(patient_weeks, patient_fvc, alpha<span class="op">=</span><span class="fl">0.8</span>, label<span class="op">=</span><span class="st">"Test Set"</span>, color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"Weeks"</span>)</span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"FVC"</span>)</span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>    plt.title(patient_encoder.inverse_transform([patient_code])[<span class="dv">0</span>])</span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_total_ppss(patient_id <span class="op">=</span> <span class="dv">0</span>, plot_pooled <span class="op">=</span> <span class="va">False</span>):</span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(all_weeks.shape)</span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(mu.shape)</span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a>    plot_patient_ppss(np.array([patient_id]))</span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(all_weeks.shape)</span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(mu.shape)</span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> plot_pooled:</span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a>        plt.plot(all_weeks, mu, color<span class="op">=</span><span class="st">'g'</span>)</span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a>        plt.fill_between(all_weeks, mu <span class="op">-</span> <span class="fl">1.64</span><span class="op">*</span>sigma, mu <span class="op">+</span> <span class="fl">1.64</span><span class="op">*</span>sigma, alpha<span class="op">=</span><span class="fl">0.05</span>, color<span class="op">=</span><span class="st">'g'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-56" class="cell" data-outputid="ed3c7a4a-163b-4be2-bd56-2fc578bcc0d3">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot for a given patient</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>plot_patient_ppss(np.array([<span class="dv">0</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>c:\Users\Dell\AppData\Local\Programs\Python\Python311\Lib\site-packages\sklearn\preprocessing\_label.py:155: DataConversionWarning: A column-vector y was passed when a 1d array was expected. Please change the shape of y to (n_samples, ), for example using ravel().
  y = column_or_1d(y, warn=True)
c:\Users\Dell\AppData\Local\Programs\Python\Python311\Lib\site-packages\sklearn\preprocessing\_label.py:155: DataConversionWarning: A column-vector y was passed when a 1d array was expected. Please change the shape of y to (n_samples, ), for example using ravel().
  y = column_or_1d(y, warn=True)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-51-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-10"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-51-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-57" class="cell" data-outputid="d28af279-8046-4fc6-ed6b-17c10fc040ed">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>predictions_test_ppss <span class="op">=</span> predictive_ppss(rng_key,</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>                                                 x_test.values,</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>                                                 sample_patient_code_test)[<span class="st">'fvc'</span>]</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>predictions_test_ppss.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>(4000, 310)</code></pre>
</div>
</div>
<div id="cell-58" class="cell" data-outputid="d62d6a14-ce86-418b-aed2-e968602fd4a4">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>mu_predictions_test_ppss <span class="op">=</span> predictions_test_ppss.mean(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>std_predictions_test_ppss <span class="op">=</span> predictions_test_ppss.std(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>maes[<span class="st">"PartialPooled_samesigma"</span>] <span class="op">=</span> mean_absolute_error(y_test, mu_predictions_test_ppss)</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>maes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>{'LinearRegression': 626.3184730275215,
 'PooledModel': 626.4611966040827,
 'PatrialPooled_samesigma': 110.46457322643649,
 'PartiallyPooled_samesigma': 110.46457322643649,
 'PatrialPooled_hypersigma': 111.37391593686996,
 'PartialPooled_samesigma': 110.46457322643649}</code></pre>
</div>
</div>
</section>
<section id="hierarchical-model-1" class="level3">
<h3 class="anchored" data-anchor-id="hierarchical-model-1">Hierarchical model</h3>
<p><span class="math inline">\(\gamma_{\sigma} \sim \text{HalfNormal}(30)\)</span></p>
<p><span class="math inline">\(\mu_{\alpha} \sim \text{Normal}(0, 500)\)</span></p>
<p><span class="math inline">\(\sigma_{\alpha} \sim \text{HalfNormal}(100)\)</span></p>
<p><span class="math inline">\(\mu_{\beta} \sim \text{Normal}(0, 500)\)</span></p>
<p><span class="math inline">\(\sigma_{\beta} \sim \text{HalfNormal}(100)\)</span></p>
<hr>
<p><code>for p in range(N_patients):</code></p>
<p><span class="math inline">\(\alpha_p \sim \text{Normal}(\mu_{\alpha}, \sigma_{\alpha})\)</span></p>
<p><span class="math inline">\(\beta_p \sim \text{Normal}(\mu_{\beta}, \sigma_{\beta})\)</span></p>
<p><span class="math inline">\(\sigma_p \sim \text{Exp}(\gamma_{\sigma})\)</span></p>
<hr>
<p><code>for i in range(N_Weeks):</code></p>
<p><span class="math inline">\(FVC_i \sim \text{Normal}(\alpha_{p[i]} + \beta_{p[i]} \cdot Week_i, \sigma_{p[i]})\)</span></p>
<div id="cell-60" class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co">### Hierarchical model</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> partial_pool_hyper_sigma(sample_weeks, sample_patient_code, sample_fvc<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>    μ_α <span class="op">=</span> numpyro.sample(<span class="st">"μ_α"</span>, dist.Normal(<span class="fl">0.0</span>, <span class="fl">500.0</span>))</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>    σ_α <span class="op">=</span> numpyro.sample(<span class="st">"σ_α"</span>, dist.HalfNormal(<span class="fl">100.0</span>))</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>    μ_β <span class="op">=</span> numpyro.sample(<span class="st">"μ_β"</span>, dist.Normal(<span class="fl">0.0</span>, <span class="fl">3.0</span>))</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>    σ_β <span class="op">=</span> numpyro.sample(<span class="st">"σ_β"</span>, dist.HalfNormal(<span class="fl">3.0</span>))</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>    gamma_sigma <span class="op">=</span> numpyro.sample(<span class="st">"gamma_sigma"</span>, dist.HalfNormal(<span class="dv">30</span>))</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>    n_patients <span class="op">=</span> <span class="bu">len</span>(np.unique(sample_patient_code))</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> numpyro.plate(<span class="st">"Participants"</span>, n_patients):</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>        α <span class="op">=</span> numpyro.sample(<span class="st">"α"</span>, dist.Normal(μ_α, σ_α))</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>        β <span class="op">=</span> numpyro.sample(<span class="st">"β"</span>, dist.Normal(μ_β, σ_β))</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>        σ <span class="op">=</span> numpyro.sample(<span class="st">"σ"</span>, dist.Exponential(gamma_sigma))</span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>    FVC_est <span class="op">=</span> α[sample_patient_code] <span class="op">+</span> β[sample_patient_code] <span class="op">*</span> sample_weeks</span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> numpyro.plate(<span class="st">"data"</span>, <span class="bu">len</span>(sample_patient_code)):</span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a>        numpyro.sample(<span class="st">"fvc"</span>, dist.Normal(FVC_est, σ[sample_patient_code]), obs<span class="op">=</span>sample_fvc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-61" class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>nuts_pphs <span class="op">=</span> NUTS(partial_pool_hyper_sigma)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>mcmc_pphs <span class="op">=</span> MCMC(nuts_pphs, num_samples<span class="op">=</span><span class="dv">4000</span>, num_warmup<span class="op">=</span><span class="dv">2000</span>)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>rng_key <span class="op">=</span> random.PRNGKey(<span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-62" class="cell" data-outputid="4cae977b-ef44-4cee-880b-d836635fb359">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>y_train.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>(1239,)</code></pre>
</div>
</div>
<div id="cell-63" class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>model_kwargs <span class="op">=</span> {<span class="st">"sample_weeks"</span>: x_train.values,</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>                <span class="st">"sample_patient_code"</span>: sample_patient_code_train,</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>                <span class="st">"sample_fvc"</span>:y_train.values}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-64" class="cell" data-outputid="547b53b6-5f43-4cc2-d6ef-dad5ccd8e4ea">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>mcmc_pphs.run(rng_key, <span class="op">**</span>model_kwargs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>sample: 100%|██████████| 6000/6000 [05:03&lt;00:00, 19.80it/s, 511 steps of size 8.39e-03. acc. prob=0.94] </code></pre>
</div>
</div>
<div id="cell-65" class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>predictive_pphs <span class="op">=</span> Predictive(partial_pool_hyper_sigma, mcmc_pphs.get_samples())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-66" class="cell" data-outputid="1b9d6eda-c246-4385-e4b9-e5697f3ede78">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>az.plot_trace(az.from_numpyro(mcmc_pphs), compact<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>array([[&lt;Axes: title={'center': 'gamma_sigma'}&gt;,
        &lt;Axes: title={'center': 'gamma_sigma'}&gt;],
       [&lt;Axes: title={'center': 'α'}&gt;, &lt;Axes: title={'center': 'α'}&gt;],
       [&lt;Axes: title={'center': 'β'}&gt;, &lt;Axes: title={'center': 'β'}&gt;],
       [&lt;Axes: title={'center': 'μ_α'}&gt;, &lt;Axes: title={'center': 'μ_α'}&gt;],
       [&lt;Axes: title={'center': 'μ_β'}&gt;, &lt;Axes: title={'center': 'μ_β'}&gt;],
       [&lt;Axes: title={'center': 'σ'}&gt;, &lt;Axes: title={'center': 'σ'}&gt;],
       [&lt;Axes: title={'center': 'σ_α'}&gt;, &lt;Axes: title={'center': 'σ_α'}&gt;],
       [&lt;Axes: title={'center': 'σ_β'}&gt;, &lt;Axes: title={'center': 'σ_β'}&gt;]],
      dtype=object)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-60-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-11"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-60-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-67" class="cell" data-outputid="02f06dad-d92d-46ce-e14b-cfb8c908625d">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>predictions_test_pphs <span class="op">=</span> predictive_pphs(rng_key,</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>                                                         sample_weeks <span class="op">=</span> x_test.values,</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>                                                         sample_patient_code <span class="op">=</span> sample_patient_code_test)[<span class="st">'fvc'</span>]</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>mu_predictions_test_h <span class="op">=</span> predictions_test_pphs.mean(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>std_predictions_test_h <span class="op">=</span> predictions_test_pphs.std(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>maes[<span class="st">"PatrialPooled_hypersigma"</span>] <span class="op">=</span> mean_absolute_error(y_test, mu_predictions_test_h)</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>coverages[<span class="st">"PatrialPooled_hypersigma"</span>] <span class="op">=</span> coverage(y_test, mu_predictions_test_h, std_predictions_test_h).item()</span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(maes)</span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(coverages)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'LinearRegression': 626.3184730275215, 'PooledModel': 626.4611966040827, 'PatrialPooled_samesigma': 110.46457322643649, 'PartiallyPooled_samesigma': 110.46457322643649, 'PatrialPooled_hypersigma': 111.37391593686996}
{'pooled': 0.9483870967741935, 'PatrialPooled_samesigma': 0.9419354838709677, 'PatrialPooled_hypersigma': 0.9451612903225807}</code></pre>
</div>
</div>
<div id="cell-68" class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predict for a given patient</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_pphs(patient_code):</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> predictive_pphs(rng_key, all_weeks, patient_code)</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> predictions[<span class="st">"fvc"</span>].mean(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">=</span> predictions[<span class="st">"fvc"</span>].std(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mu, sigma</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the predictions for a given patient</span></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_patient_pphs(patient_code):</span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>    mu, sigma <span class="op">=</span> predict_pphs(patient_code)</span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>    plt.scatter(all_weeks, mu)</span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>    plt.fill_between(all_weeks, mu <span class="op">-</span> <span class="fl">1.64</span><span class="op">*</span>sigma, mu <span class="op">+</span> <span class="fl">1.64</span><span class="op">*</span>sigma, alpha<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>    id_to_patient <span class="op">=</span> patient_encoder.inverse_transform([patient_code])[<span class="dv">0</span>]</span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(id_to_patient[0], patient_code)</span></span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(patient_code, id_to_patient)</span></span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a>    patient_weeks <span class="op">=</span> x_test.values[sample_patient_code_test <span class="op">==</span> patient_code]</span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a>    patient_fvc <span class="op">=</span> y_test.values[sample_patient_code_test <span class="op">==</span> patient_code]</span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># patient_weeks = train[train["Patient"] == id_to_patient]["Weeks"]</span></span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># patient_fvc = train[train["Patient"] == id_to_patient]["FVC"]</span></span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a>    plt.scatter(patient_weeks, patient_fvc, alpha<span class="op">=</span><span class="fl">0.8</span>, label<span class="op">=</span><span class="st">"Test Set"</span>, color<span class="op">=</span><span class="st">"black"</span>)</span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">#plt.scatter(sample_weeks[train["patient_code"] == patient_code.item()], fvc[train["patient_code"] == patient_code.item()], alpha=0.5)</span></span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">"Weeks"</span>)</span>
<span id="cb88-25"><a href="#cb88-25" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">"FVC"</span>)</span>
<span id="cb88-26"><a href="#cb88-26" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb88-27"><a href="#cb88-27" aria-hidden="true" tabindex="-1"></a>    plt.title(patient_encoder.inverse_transform([patient_code])[<span class="dv">0</span>])</span>
<span id="cb88-28"><a href="#cb88-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-29"><a href="#cb88-29" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_total_pphs(patient_id <span class="op">=</span> <span class="dv">0</span>, plot_pooled <span class="op">=</span> <span class="va">False</span>):</span>
<span id="cb88-30"><a href="#cb88-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(all_weeks.shape)</span>
<span id="cb88-31"><a href="#cb88-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(mu.shape)</span>
<span id="cb88-32"><a href="#cb88-32" aria-hidden="true" tabindex="-1"></a>    plot_patient_pphs(np.array([patient_id]))</span>
<span id="cb88-33"><a href="#cb88-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(all_weeks.shape)</span>
<span id="cb88-34"><a href="#cb88-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(mu.shape)</span>
<span id="cb88-35"><a href="#cb88-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> plot_pooled:</span>
<span id="cb88-36"><a href="#cb88-36" aria-hidden="true" tabindex="-1"></a>        plt.plot(all_weeks, mu, color<span class="op">=</span><span class="st">'g'</span>)</span>
<span id="cb88-37"><a href="#cb88-37" aria-hidden="true" tabindex="-1"></a>        plt.fill_between(all_weeks, mu <span class="op">-</span> <span class="fl">1.64</span><span class="op">*</span>sigma, mu <span class="op">+</span> <span class="fl">1.64</span><span class="op">*</span>sigma, alpha<span class="op">=</span><span class="fl">0.05</span>, color<span class="op">=</span><span class="st">'g'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-69" class="cell" data-outputid="aa14d9ba-cedb-4170-f07c-4a45fd05d8d4">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot for a given patient</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>plot_patient_pphs(np.array([<span class="dv">0</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>c:\Users\Dell\AppData\Local\Programs\Python\Python311\Lib\site-packages\sklearn\preprocessing\_label.py:155: DataConversionWarning: A column-vector y was passed when a 1d array was expected. Please change the shape of y to (n_samples, ), for example using ravel().
  y = column_or_1d(y, warn=True)
c:\Users\Dell\AppData\Local\Programs\Python\Python311\Lib\site-packages\sklearn\preprocessing\_label.py:155: DataConversionWarning: A column-vector y was passed when a 1d array was expected. Please change the shape of y to (n_samples, ), for example using ravel().
  y = column_or_1d(y, warn=True)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-63-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-12"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-63-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="question-3" class="level1">
<h1>Question 3</h1>
<p>Use your version of following models to reproduce figure 4 from the paper referenced at conditional neural network paper. You can also refer to the notebook in the course. - Hypernet - Neural Processes</p>
<section id="hyper-network" class="level2">
<h2 class="anchored" data-anchor-id="hyper-network">Hyper Network</h2>
<div id="cell-73" class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision.transforms <span class="im">as</span> transforms</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="co"># import torch.nn.functional as F</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.optim <span class="im">as</span> optim</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset, DataLoader, Subset</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a><span class="co"># import torchvision.datasets as datasets</span></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn <span class="im">import</span> preprocessing</span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> trange</span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tabulate <span class="im">import</span> tabulate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-74" class="cell" data-outputid="42040a20-aa9d-46c8-a995-86485a0c4221">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># device = torch.device("cuda" if torch.cuda.is_available() else "cpu")</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> torch.device(<span class="st">"cuda:3"</span>)</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(device)</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>current_device <span class="op">=</span> device <span class="co">#torch.cuda.current_device()</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>device_name <span class="op">=</span> torch.cuda.get_device_name(current_device)</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Current GPU assigned: </span><span class="sc">{</span>current_device<span class="sc">}</span><span class="ss">, Name: </span><span class="sc">{</span>device_name<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>cuda:3
Current GPU assigned: cuda:3, Name: NVIDIA A100-SXM4-80GB</code></pre>
</div>
</div>
<p>Celeba data <a href="https://mmlab.ie.cuhk.edu.hk/projects/CelebA.html">link</a></p>
<p>Note book ref <a href="">link</a></p>
<section id="prepare-data" class="level3">
<h3 class="anchored" data-anchor-id="prepare-data">prepare data</h3>
<div id="cell-77" class="cell" data-outputid="95ba2e45-e25f-4b6a-cad9-b41b39881ca3">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import os</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="co"># data_root = '/home/jaiswalsuraj/suraj_work/projects/data/celeba/img_align_celeba'</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="co"># # Check if the specified directory exists</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a><span class="co"># if os.path.exists(data_root):</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     # List all files in the directory with a specific image extension (e.g., .jpg)</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     image_files = [f for f in os.listdir(data_root) if f.endswith('.jpg')]</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Get the count of image files</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     num_images = len(image_files)</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(f"Number of images in '{data_root}': {num_images}")</span></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a><span class="co"># else:</span></span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(f"The directory '{data_root}' does not exist.")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of images in '/home/jaiswalsuraj/suraj_work/projects/data/celeba/img_align_celeba': 202599</code></pre>
</div>
</div>
<div id="cell-78" class="cell" data-outputid="82fcf015-7b2a-41cc-8e7b-992dcf47535d">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># data_folder_size = 200000</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="co"># data_root = '/home/jaiswalsuraj/suraj_work/projects/data/celeba/img_align_celeba'</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="co"># output_dir = f'/home/jaiswalsuraj/suraj_work/projects/data/celeba/img_align_celeba_{data_folder_size}'</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="co"># # Check if the specified input directory exists</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a><span class="co"># if os.path.exists(data_root):</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Ensure the output directory exists, or create it if necessary</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     if not os.path.exists(output_dir):</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a><span class="co">#         os.makedirs(output_dir)</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     # List all files in the input directory</span></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a><span class="co">#     all_image_files = [f for f in os.listdir(data_root) if f.endswith('.jpg')]</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a><span class="co">#     # random_images = random.sample(all_image_files, data_folder_size)</span></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     images_list = all_image_files[:data_folder_size]</span></span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Copy the randomly selected images to the output directory</span></span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a><span class="co">#     for image_file in images_list:</span></span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a><span class="co">#         src_path = os.path.join(data_root, image_file)</span></span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a><span class="co">#         dst_path = os.path.join(output_dir, image_file)</span></span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a><span class="co">#         shutil.copy2(src_path, dst_path)</span></span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(f"Successfully copied {data_folder_size} random images to '{output_dir}'.")</span></span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a><span class="co"># else:</span></span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(f"The input directory '{data_root}' does not exist.")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Successfully copied 200000 random images to '/home/jaiswalsuraj/suraj_work/projects/data/celeba/img_align_celeba_200000'.</code></pre>
</div>
</div>
<p>test data: last 2599 images</p>
<div id="cell-80" class="cell" data-outputid="58fd7b22-9231-49c7-cd5c-b375f5743d7e">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># data_folder_size = 2599</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="co"># data_root = '/home/jaiswalsuraj/suraj_work/projects/data/celeba/img_align_celeba'</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="co"># output_dir = f'/home/jaiswalsuraj/suraj_work/projects/data/celeba/img_align_celeba_{data_folder_size}'</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="co"># # Check if the specified input directory exists</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="co"># if os.path.exists(data_root):</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Ensure the output directory exists, or create it if necessary</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     if not os.path.exists(output_dir):</span></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a><span class="co">#         os.makedirs(output_dir)</span></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     # List all files in the input directory</span></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a><span class="co">#     all_image_files = [f for f in os.listdir(data_root) if f.endswith('.jpg')]</span></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a><span class="co">#     # random_images = random.sample(all_image_files, data_folder_size)</span></span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     images_list = all_image_files[data_folder_size:]</span></span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Copy the randomly selected images to the output directory</span></span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a><span class="co">#     for image_file in images_list:</span></span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a><span class="co">#         src_path = os.path.join(data_root, image_file)</span></span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a><span class="co">#         dst_path = os.path.join(output_dir, image_file)</span></span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a><span class="co">#         shutil.copy2(src_path, dst_path)</span></span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(f"Successfully copied {data_folder_size} random images to '{output_dir}'.")</span></span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a><span class="co"># else:</span></span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(f"The input directory '{data_root}' does not exist.")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Successfully copied 2599 random images to '/home/jaiswalsuraj/suraj_work/projects/data/celeba/img_align_celeba_2599'.</code></pre>
</div>
</div>
</section>
<section id="extras" class="level3">
<h3 class="anchored" data-anchor-id="extras">Extras</h3>
<div id="cell-82" class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CustomImageDataset(Dataset):</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, data_root, transform<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.data_root <span class="op">=</span> data_root</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.transform <span class="op">=</span> transform</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.image_files <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> os.listdir(data_root) <span class="cf">if</span> f.endswith(<span class="st">'.jpg'</span>)]</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.image_files)</span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx):</span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>        img_name <span class="op">=</span> os.path.join(<span class="va">self</span>.data_root, <span class="va">self</span>.image_files[idx])</span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>        image <span class="op">=</span> Image.<span class="bu">open</span>(img_name)</span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.transform:</span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>            image <span class="op">=</span> <span class="va">self</span>.transform(image)</span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> image</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-83" class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a coordinate dataset from the image</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_coordinate_map(img):</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a><span class="co">    img: torch.Tensor of shape (num_channels, height, width)</span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a><span class="co">    return: tuple of torch.Tensor of shape (height* width, 2) and torch.tensor containing the (num_channels)</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>    num_channels, height, width <span class="op">=</span> img.shape</span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a 2D grid of (x,y) coordinates</span></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>    x_coords <span class="op">=</span> torch.arange(width).repeat(height, <span class="dv">1</span>)</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>    y_coords <span class="op">=</span> torch.arange(height).repeat(width, <span class="dv">1</span>).t()</span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>    x_coords <span class="op">=</span> x_coords.reshape(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a>    y_coords <span class="op">=</span> y_coords.reshape(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine the x and y coordinates into a single tensor</span></span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> torch.stack([x_coords, y_coords], dim<span class="op">=</span><span class="dv">1</span>).<span class="bu">float</span>()</span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Move X to GPU if available</span></span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> X.to(device)</span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-23"><a href="#cb101-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a tensor containing the image pixel values</span></span>
<span id="cb101-24"><a href="#cb101-24" aria-hidden="true" tabindex="-1"></a>    Y <span class="op">=</span> img.reshape(<span class="op">-</span><span class="dv">1</span>, num_channels).<span class="bu">float</span>().to(device)</span>
<span id="cb101-25"><a href="#cb101-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> X, Y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-84" class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> neg_loglikelyhood(y_pred,log_sigma,y_true):</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>    cov_matrix <span class="op">=</span> torch.diag_embed(log_sigma.exp())</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>    dist <span class="op">=</span> torch.distributions.MultivariateNormal(y_pred,cov_matrix,validate_args<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span> dist.log_prob(y_true).<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-85" class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_params(model):</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># return torch.sum(p.numel() for p in model.parameters() if p.requires_grad)</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.<span class="bu">sum</span>(torch.tensor([p.numel() <span class="cf">for</span> p <span class="kw">in</span> model.parameters()]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="loading-and-preprocessing" class="level3">
<h3 class="anchored" data-anchor-id="loading-and-preprocessing">loading and preprocessing</h3>
<div id="cell-87" class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">1</span> <span class="co"># keep this to 1</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>img_size <span class="op">=</span> <span class="dv">32</span> <span class="co"># Change as needed</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the root directory where the dataset is located</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>data_root <span class="op">=</span> <span class="st">'/home/jaiswalsuraj/suraj_work/projects/data/celeba/img_align_celeba_10000'</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the data transformations</span></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>transform <span class="op">=</span> transforms.Compose([</span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>    transforms.Resize((img_size, img_size)),  <span class="co"># Resize the images to a common size (adjust as needed)</span></span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>    transforms.ToTensor(),   <span class="co"># Convert images to tensors</span></span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a><span class="co"># default shape is torch.Size([3, 218, 178])</span></span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the custom dataset</span></span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>celeba_dataset <span class="op">=</span> CustomImageDataset(data_root, transform<span class="op">=</span>transform)</span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a data loader</span></span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a>data_loader <span class="op">=</span> DataLoader(celeba_dataset, batch_size<span class="op">=</span>batch_size, shuffle<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Original image after transformation</p>
<div id="cell-89" class="cell" data-outputid="61e11957-15f7-4ba9-f39f-853982bb038a">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>plt.imshow(torch.einsum(<span class="st">'chw -&gt; hwc'</span>, data_loader.dataset[<span class="dv">33</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-75-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-13"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-75-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Original image</p>
<div id="cell-91" class="cell" data-outputid="b8e70238-14e8-4109-92d6-3d9779773b2c">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>plt.imshow(torch.einsum(<span class="st">'chw -&gt; hwc'</span>, data_loader.dataset[<span class="dv">33</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-76-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-14"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-76-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
<section id="model-defination" class="level3">
<h3 class="anchored" data-anchor-id="model-defination">model defination</h3>
<section id="target-net-defination" class="level4">
<h4 class="anchored" data-anchor-id="target-net-defination">target net defination</h4>
<div id="cell-94" class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a MLP with 5 hidden layers with 256 neurons each and ReLU activations.</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Input is (x, y) and output is (r, g, b) or (g) for grayscale</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="co"># here we output 6 values (3 for RGB mean and 3 for RGB std)</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> <span class="dv">128</span> <span class="co"># hidden dim of model</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TargetNet(nn.Module):</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _init_siren(<span class="va">self</span>, activation_scale):</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc1.weight.data.uniform_(<span class="op">-</span><span class="dv">1</span><span class="op">/</span><span class="va">self</span>.fc1.in_features, <span class="dv">1</span><span class="op">/</span><span class="va">self</span>.fc1.in_features)</span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> layers <span class="kw">in</span> [<span class="va">self</span>.fc2, <span class="va">self</span>.fc3, <span class="va">self</span>.fc4, <span class="va">self</span>.fc5]:</span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>            layers.weight.data.uniform_(<span class="op">-</span>np.sqrt(<span class="dv">6</span><span class="op">/</span><span class="va">self</span>.fc2.in_features)<span class="op">/</span>activation_scale,</span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>                                        np.sqrt(<span class="dv">6</span><span class="op">/</span><span class="va">self</span>.fc2.in_features)<span class="op">/</span>activation_scale)</span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, activation<span class="op">=</span>torch.relu, n_out<span class="op">=</span><span class="dv">1</span>, activation_scale<span class="op">=</span><span class="fl">1.0</span>):</span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.activation <span class="op">=</span> activation</span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.activation_scale <span class="op">=</span> activation_scale</span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc1 <span class="op">=</span> nn.Linear(<span class="dv">2</span>, s) <span class="co"># input size is 2 (x, y) location of pixel</span></span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc2 <span class="op">=</span> nn.Linear(s, s)</span>
<span id="cb107-19"><a href="#cb107-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc3 <span class="op">=</span> nn.Linear(s, s)</span>
<span id="cb107-20"><a href="#cb107-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc4 <span class="op">=</span> nn.Linear(s, s)</span>
<span id="cb107-21"><a href="#cb107-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc5 <span class="op">=</span> nn.Linear(s, n_out) <span class="co">#gray scale image (1) or RGB (3)</span></span>
<span id="cb107-22"><a href="#cb107-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.activation <span class="op">==</span> torch.sin:</span>
<span id="cb107-23"><a href="#cb107-23" aria-hidden="true" tabindex="-1"></a>            <span class="co"># init weights and biases for sine activation</span></span>
<span id="cb107-24"><a href="#cb107-24" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>._init_siren(activation_scale<span class="op">=</span><span class="va">self</span>.activation_scale)</span>
<span id="cb107-25"><a href="#cb107-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-26"><a href="#cb107-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb107-27"><a href="#cb107-27" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.activation(<span class="va">self</span>.activation_scale<span class="op">*</span><span class="va">self</span>.fc1(x))</span>
<span id="cb107-28"><a href="#cb107-28" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.activation(<span class="va">self</span>.activation_scale<span class="op">*</span><span class="va">self</span>.fc2(x))</span>
<span id="cb107-29"><a href="#cb107-29" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.activation(<span class="va">self</span>.activation_scale<span class="op">*</span><span class="va">self</span>.fc3(x))</span>
<span id="cb107-30"><a href="#cb107-30" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.activation(<span class="va">self</span>.activation_scale<span class="op">*</span><span class="va">self</span>.fc4(x))</span>
<span id="cb107-31"><a href="#cb107-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.fc5(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="hypernetwork-defination" class="level4">
<h4 class="anchored" data-anchor-id="hypernetwork-defination">Hypernetwork defination</h4>
<section id="input-x-y-r-g-b" class="level5">
<h5 class="anchored" data-anchor-id="input-x-y-r-g-b">Input: (x, y, R, G, B)</h5>
</section>
<section id="output-our-hypernetwork-should-have-the-output-equal-to-the-number-of-parameters-in-the-main-network." class="level5">
<h5 class="anchored" data-anchor-id="output-our-hypernetwork-should-have-the-output-equal-to-the-number-of-parameters-in-the-main-network.">Output: Our Hypernetwork should have the output equal to the number of parameters in the main network.</h5>
<div id="cell-96" class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pass total params of target network before calling the hypernetwork model</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HyperNet(nn.Module):</span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, total_params, num_neurons<span class="op">=</span><span class="dv">128</span>, activation<span class="op">=</span>torch.relu):</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.activation <span class="op">=</span> activation</span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n_out <span class="op">=</span> total_params</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc1 <span class="op">=</span> nn.Linear(<span class="dv">5</span>, num_neurons)</span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc2 <span class="op">=</span> nn.Linear(num_neurons, num_neurons)</span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc3 <span class="op">=</span> nn.Linear(num_neurons, <span class="va">self</span>.n_out)</span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.activation(<span class="va">self</span>.fc1(x))</span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.activation(<span class="va">self</span>.fc2(x))</span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.fc3(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="initialize-the-model-and-input" class="level3">
<h3 class="anchored" data-anchor-id="initialize-the-model-and-input">Initialize the model and input</h3>
<section id="initialize-the-target-network" class="level4">
<h4 class="anchored" data-anchor-id="initialize-the-target-network">Initialize the target network</h4>
<div id="cell-99" class="cell" data-outputid="d18ce460-ce59-4e4c-a69b-a3db2b575c3b">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchinfo <span class="im">import</span> summary</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>targetnet <span class="op">=</span> TargetNet(activation<span class="op">=</span>torch.relu, n_out<span class="op">=</span><span class="dv">6</span>, activation_scale<span class="op">=</span><span class="dv">1</span>).to(device)</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>summary(targetnet, input_size<span class="op">=</span>(img_size<span class="op">*</span> img_size, <span class="dv">2</span>)) <span class="co">#32*32 =1024 is the image size lentgh, 2 is x,y coordinate</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a><span class="co"># outputs 6: 1,2,3 mean of each channel and 4,5,6 are log sigma of each channel</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>==========================================================================================
Layer (type:depth-idx)                   Output Shape              Param #
==========================================================================================
TargetNet                                [1024, 6]                 --
├─Linear: 1-1                            [1024, 128]               384
├─Linear: 1-2                            [1024, 128]               16,512
├─Linear: 1-3                            [1024, 128]               16,512
├─Linear: 1-4                            [1024, 128]               16,512
├─Linear: 1-5                            [1024, 6]                 774
==========================================================================================
Total params: 50,694
Trainable params: 50,694
Non-trainable params: 0
Total mult-adds (M): 51.91
==========================================================================================
Input size (MB): 0.01
Forward/backward pass size (MB): 4.24
Params size (MB): 0.20
Estimated Total Size (MB): 4.45
==========================================================================================</code></pre>
</div>
</div>
<div id="cell-100" class="cell" data-outputid="17953382-ca7a-412a-b9f5-f270a3b19f02">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>targetnet</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>TargetNet(
  (fc1): Linear(in_features=2, out_features=128, bias=True)
  (fc2): Linear(in_features=128, out_features=128, bias=True)
  (fc3): Linear(in_features=128, out_features=128, bias=True)
  (fc4): Linear(in_features=128, out_features=128, bias=True)
  (fc5): Linear(in_features=128, out_features=6, bias=True)
)</code></pre>
</div>
</div>
<div id="cell-101" class="cell" data-outputid="76d93f4e-49ac-4aa0-f07a-e7b17655dbe4">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>count_params(targetnet)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>tensor(50694)</code></pre>
</div>
</div>
</section>
<section id="initialize-the-hypernetwork-model" class="level4">
<h4 class="anchored" data-anchor-id="initialize-the-hypernetwork-model">initialize the hypernetwork model</h4>
<div id="cell-103" class="cell" data-outputid="97c6cf29-4db1-44ae-99d5-851fc360a4e6">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>hypernet <span class="op">=</span> HyperNet(total_params<span class="op">=</span>count_params(targetnet), activation<span class="op">=</span>torch.sin).to(device)</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(hypernet)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>HyperNet(
  (fc1): Linear(in_features=5, out_features=128, bias=True)
  (fc2): Linear(in_features=128, out_features=128, bias=True)
  (fc3): Linear(in_features=128, out_features=50694, bias=True)
)</code></pre>
</div>
</div>
<div id="cell-104" class="cell" data-outputid="9779a715-e34c-4f14-ee63-562e4210933b">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>summary(hypernet,input_size<span class="op">=</span>(img_size<span class="op">*</span> img_size,<span class="dv">5</span>))  <span class="co"># 32*32 = 1024 is the image size length, 5 is the input(x,y,r,g,b) to hypernet</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>==========================================================================================
Layer (type:depth-idx)                   Output Shape              Param #
==========================================================================================
HyperNet                                 [1024, 50694]             --
├─Linear: 1-1                            [1024, 128]               768
├─Linear: 1-2                            [1024, 128]               16,512
├─Linear: 1-3                            [1024, 50694]             6,539,526
==========================================================================================
Total params: 6,556,806
Trainable params: 6,556,806
Non-trainable params: 0
Total mult-adds (G): 6.71
==========================================================================================
Input size (MB): 0.02
Forward/backward pass size (MB): 417.38
Params size (MB): 26.23
Estimated Total Size (MB): 443.63
==========================================================================================</code></pre>
</div>
</div>
<div id="cell-105" class="cell" data-outputid="fca4e05b-bc86-4bdb-9ce9-f7a96b56abe8">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>table_data <span class="op">=</span> []</span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>total_params <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>start_end_mapping <span class="op">=</span> {}</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, param <span class="kw">in</span> targetnet.named_parameters():</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>    param_count <span class="op">=</span> torch.prod(torch.tensor(param.shape)).item()</span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>    total_params <span class="op">+=</span> param_count</span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>    end <span class="op">=</span> total_params</span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>    table_data.append([name, param.shape, param_count, start, end])</span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>    start_end_mapping[name] <span class="op">=</span> (start, end)</span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> end</span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tabulate(table_data, headers<span class="op">=</span>[<span class="st">"Layer Name"</span>, <span class="st">"Shape"</span>, <span class="st">"Parameter Count"</span>, <span class="st">"Start Index"</span>, <span class="st">"End Index"</span>]))</span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total number of parameters: </span><span class="sc">{</span>total_params<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Layer Name    Shape                     Parameter Count    Start Index    End Index
------------  ----------------------  -----------------  -------------  -----------
fc1.weight    torch.Size([128, 2])                  256              0          256
fc1.bias      torch.Size([128])                     128            256          384
fc2.weight    torch.Size([128, 128])              16384            384        16768
fc2.bias      torch.Size([128])                     128          16768        16896
fc3.weight    torch.Size([128, 128])              16384          16896        33280
fc3.bias      torch.Size([128])                     128          33280        33408
fc4.weight    torch.Size([128, 128])              16384          33408        49792
fc4.bias      torch.Size([128])                     128          49792        49920
fc5.weight    torch.Size([6, 128])                  768          49920        50688
fc5.bias      torch.Size([6])                         6          50688        50694
Total number of parameters: 50694</code></pre>
</div>
</div>
</section>
<section id="initialize-the-input" class="level4">
<h4 class="anchored" data-anchor-id="initialize-the-input">initialize the input</h4>
<div id="cell-107" class="cell" data-outputid="f388f213-7919-49d2-ad81-5a78b4338c32">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>corr, vals <span class="op">=</span> create_coordinate_map(data_loader.dataset[<span class="dv">0</span>])</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>corr, vals</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>(tensor([[ 0.,  0.],
         [ 1.,  0.],
         [ 2.,  0.],
         ...,
         [29., 31.],
         [30., 31.],
         [31., 31.]], device='cuda:3'),
 tensor([[0.4510, 0.4706, 0.4824],
         [0.4745, 0.4745, 0.4471],
         [0.4667, 0.4353, 0.5412],
         ...,
         [0.0314, 0.0549, 0.0471],
         [0.0431, 0.0392, 0.0510],
         [0.0549, 0.0392, 0.0549]], device='cuda:3'))</code></pre>
</div>
</div>
<div id="cell-108" class="cell" data-outputid="a87efd37-21e7-4ac1-de67-f9cabe2fc903">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>scaler_img <span class="op">=</span> preprocessing.MinMaxScaler().fit(corr.cpu())</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>xy <span class="op">=</span> torch.tensor(scaler_img.transform(corr.cpu())).<span class="bu">float</span>().to(device)</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>xy, xy.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>(tensor([[0.0000, 0.0000],
         [0.0323, 0.0000],
         [0.0645, 0.0000],
         ...,
         [0.9355, 1.0000],
         [0.9677, 1.0000],
         [1.0000, 1.0000]], device='cuda:3'),
 torch.Size([1024, 2]))</code></pre>
</div>
</div>
</section>
</section>
<section id="training-loop" class="level3">
<h3 class="anchored" data-anchor-id="training-loop">Training loop</h3>
<div id="cell-110" class="cell" data-outputid="b5a167ce-fb1c-4b8f-e42f-1671cd08eb0f">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>n_epochs<span class="op">=</span><span class="dv">20</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> <span class="fl">0.003</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>targetnet <span class="op">=</span> TargetNet(activation<span class="op">=</span>torch.relu, n_out<span class="op">=</span><span class="dv">6</span>, activation_scale<span class="op">=</span><span class="dv">1</span>).to(device)</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>hypernet <span class="op">=</span> HyperNet(total_params<span class="op">=</span>count_params(targetnet), activation<span class="op">=</span>torch.relu).to(device)</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> optim.Adam(hypernet.parameters(),lr<span class="op">=</span>lr) <span class="co"># only hypernet is updated</span></span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>n_context <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Context Points="</span>,n_context)</span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> epoch <span class="kw">in</span> trange(n_epochs):</span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a>    c_idx <span class="op">=</span> np.array(random.sample(<span class="bu">range</span>(<span class="dv">1023</span>),n_context))</span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Epoch="</span>,epoch<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a>    epoch_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a>    i<span class="op">=</span><span class="dv">1</span></span>
<span id="cb125-17"><a href="#cb125-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-18"><a href="#cb125-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> data <span class="kw">in</span> data_loader:</span>
<span id="cb125-19"><a href="#cb125-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(data.shape)</span></span>
<span id="cb125-20"><a href="#cb125-20" aria-hidden="true" tabindex="-1"></a>        optimizer.zero_grad()</span>
<span id="cb125-21"><a href="#cb125-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-22"><a href="#cb125-22" aria-hidden="true" tabindex="-1"></a>        pixel_intensity <span class="op">=</span> data.reshape(<span class="dv">3</span>,<span class="op">-</span><span class="dv">1</span>).T.to(device).<span class="bu">float</span>()</span>
<span id="cb125-23"><a href="#cb125-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">input</span> <span class="op">=</span> torch.concatenate([xy[c_idx],pixel_intensity[c_idx]],axis<span class="op">=</span><span class="dv">1</span>).<span class="bu">float</span>()</span>
<span id="cb125-24"><a href="#cb125-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-25"><a href="#cb125-25" aria-hidden="true" tabindex="-1"></a>        hyper_out <span class="op">=</span> hypernet(<span class="bu">input</span>)</span>
<span id="cb125-26"><a href="#cb125-26" aria-hidden="true" tabindex="-1"></a>        hyper_out <span class="op">=</span> torch.mean(hyper_out,dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb125-27"><a href="#cb125-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-28"><a href="#cb125-28" aria-hidden="true" tabindex="-1"></a>        target_dict <span class="op">=</span>{}</span>
<span id="cb125-29"><a href="#cb125-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name,param <span class="kw">in</span> targetnet.named_parameters():</span>
<span id="cb125-30"><a href="#cb125-30" aria-hidden="true" tabindex="-1"></a>            start,end <span class="op">=</span> start_end_mapping[name]</span>
<span id="cb125-31"><a href="#cb125-31" aria-hidden="true" tabindex="-1"></a>            target_dict[name] <span class="op">=</span> hyper_out[start:end].reshape(param.shape)</span>
<span id="cb125-32"><a href="#cb125-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-33"><a href="#cb125-33" aria-hidden="true" tabindex="-1"></a>        img_out <span class="op">=</span> torch.func.functional_call(targetnet, target_dict, xy)</span>
<span id="cb125-34"><a href="#cb125-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(img_out.shape, img_out[:,:3].shape, img_out[:,3:].shape, pixel_intensity.shape)</span></span>
<span id="cb125-35"><a href="#cb125-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print( img_out[:,:3], img_out[:,3:], pixel_intensity)</span></span>
<span id="cb125-36"><a href="#cb125-36" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> neg_loglikelyhood(img_out[:,:<span class="dv">3</span>],img_out[:,<span class="dv">3</span>:],pixel_intensity)</span>
<span id="cb125-37"><a href="#cb125-37" aria-hidden="true" tabindex="-1"></a>        loss.backward()</span>
<span id="cb125-38"><a href="#cb125-38" aria-hidden="true" tabindex="-1"></a>        optimizer.step()</span>
<span id="cb125-39"><a href="#cb125-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-40"><a href="#cb125-40" aria-hidden="true" tabindex="-1"></a>        epoch_loss <span class="op">=</span> epoch_loss <span class="op">+</span> loss.item()</span>
<span id="cb125-41"><a href="#cb125-41" aria-hidden="true" tabindex="-1"></a>        i<span class="op">=</span>i<span class="op">+</span><span class="dv">1</span></span>
<span id="cb125-42"><a href="#cb125-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-43"><a href="#cb125-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Epoch Loss="</span>,epoch_loss<span class="op">/</span><span class="bu">len</span>(data_loader))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Context Points= 100</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  0%|          | 0/20 [00:00&lt;?, ?it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch= 1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  5%|▌         | 1/20 [01:05&lt;20:42, 65.40s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -395.47315481672285
Epoch= 2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 10%|█         | 2/20 [02:10&lt;19:37, 65.41s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -915.5049703121185
Epoch= 3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 15%|█▌        | 3/20 [03:15&lt;18:29, 65.26s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1166.0503022047044
Epoch= 4</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 20%|██        | 4/20 [04:21&lt;17:24, 65.28s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1349.56748127985
Epoch= 5</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 25%|██▌       | 5/20 [05:26&lt;16:19, 65.30s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1396.8538594449997
Epoch= 6</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 30%|███       | 6/20 [06:31&lt;15:14, 65.31s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1479.6613237543106
Epoch= 7</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 35%|███▌      | 7/20 [07:37&lt;14:09, 65.36s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1449.8615832103728
Epoch= 8</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 40%|████      | 8/20 [08:42&lt;13:04, 65.38s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1528.4998937654495
Epoch= 9</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 45%|████▌     | 9/20 [09:47&lt;11:58, 65.31s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1538.7266953744888
Epoch= 10</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 50%|█████     | 10/20 [10:53&lt;10:53, 65.36s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1574.4109719749451
Epoch= 11</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 55%|█████▌    | 11/20 [11:58&lt;09:48, 65.35s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1558.2231241334914
Epoch= 12</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 60%|██████    | 12/20 [13:03&lt;08:42, 65.32s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1585.886608516693
Epoch= 13</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 65%|██████▌   | 13/20 [14:09&lt;07:36, 65.27s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1586.6056880670546
Epoch= 14</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 70%|███████   | 14/20 [15:14&lt;06:31, 65.23s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1561.2374246302604
Epoch= 15</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 75%|███████▌  | 15/20 [16:19&lt;05:25, 65.20s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1606.3488553873062
Epoch= 16</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 80%|████████  | 16/20 [17:24&lt;04:20, 65.24s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1637.4123486403466
Epoch= 17</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 85%|████████▌ | 17/20 [18:30&lt;03:15, 65.29s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1656.406247360611
Epoch= 18</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 90%|█████████ | 18/20 [19:33&lt;02:09, 64.69s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1621.5405502536773
Epoch= 19</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 95%|█████████▌| 19/20 [20:38&lt;01:04, 64.88s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1708.3212175039291
Epoch= 20</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 20/20 [21:44&lt;00:00, 65.21s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1700.857941632271</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
</div>
</section>
<section id="saving-and-loading-the-model" class="level3">
<h3 class="anchored" data-anchor-id="saving-and-loading-the-model">saving and loading the model</h3>
<div id="cell-112" class="cell">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>torch.save(hypernet.state_dict(), <span class="st">'hypernet_model_10000.pth'</span>)</span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a>torch.save(targetnet.state_dict(), <span class="st">'targetnet_model_10000.pth'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-113" class="cell" data-outputid="09be685a-d39d-496f-8fb5-2f23ff48e414">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the hypernet and targetnet models</span></span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>hypernet <span class="op">=</span> HyperNet(total_params<span class="op">=</span>count_params(targetnet), activation<span class="op">=</span>torch.relu).to(device)</span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>hypernet.load_state_dict(torch.load(<span class="st">'hypernet_model_10000.pth'</span>))</span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>hypernet.<span class="bu">eval</span>()  <span class="co"># Set the model to evaluation mode</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>HyperNet(
  (fc1): Linear(in_features=5, out_features=128, bias=True)
  (fc2): Linear(in_features=128, out_features=128, bias=True)
  (fc3): Linear(in_features=128, out_features=50694, bias=True)
)</code></pre>
</div>
</div>
<div id="cell-114" class="cell" data-outputid="9f1f5def-bfbf-4e66-d30f-614e0760df3b">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a>targetnet <span class="op">=</span> TargetNet(activation<span class="op">=</span>torch.relu, n_out<span class="op">=</span><span class="dv">6</span>, activation_scale<span class="op">=</span><span class="dv">1</span>).to(device)</span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a>targetnet.load_state_dict(torch.load(<span class="st">'targetnet_model_10000.pth'</span>))</span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a>targetnet.<span class="bu">eval</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>TargetNet(
  (fc1): Linear(in_features=2, out_features=128, bias=True)
  (fc2): Linear(in_features=128, out_features=128, bias=True)
  (fc3): Linear(in_features=128, out_features=128, bias=True)
  (fc4): Linear(in_features=128, out_features=128, bias=True)
  (fc5): Linear(in_features=128, out_features=6, bias=True)
)</code></pre>
</div>
</div>
</section>
<section id="plots" class="level3">
<h3 class="anchored" data-anchor-id="plots">Plots</h3>
<p>loading the test data</p>
<div id="cell-117" class="cell">
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">1</span> <span class="co"># keep this to 1</span></span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>img_size <span class="op">=</span> <span class="dv">32</span> <span class="co"># Change as needed</span></span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the root directory where the dataset is located</span></span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a>data_root <span class="op">=</span> <span class="st">'/home/jaiswalsuraj/suraj_work/projects/data/celeba/img_align_celeba_2599'</span></span>
<span id="cb175-6"><a href="#cb175-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-7"><a href="#cb175-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the data transformations</span></span>
<span id="cb175-8"><a href="#cb175-8" aria-hidden="true" tabindex="-1"></a>transform <span class="op">=</span> transforms.Compose([</span>
<span id="cb175-9"><a href="#cb175-9" aria-hidden="true" tabindex="-1"></a>    transforms.Resize((img_size, img_size)),  <span class="co"># Resize the images to a common size (adjust as needed)</span></span>
<span id="cb175-10"><a href="#cb175-10" aria-hidden="true" tabindex="-1"></a>    transforms.ToTensor(),   <span class="co"># Convert images to tensors</span></span>
<span id="cb175-11"><a href="#cb175-11" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb175-12"><a href="#cb175-12" aria-hidden="true" tabindex="-1"></a><span class="co"># default shape is torch.Size([3, 218, 178])</span></span>
<span id="cb175-13"><a href="#cb175-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the custom dataset</span></span>
<span id="cb175-14"><a href="#cb175-14" aria-hidden="true" tabindex="-1"></a>celeba_dataset <span class="op">=</span> CustomImageDataset(data_root, transform<span class="op">=</span>transform)</span>
<span id="cb175-15"><a href="#cb175-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-16"><a href="#cb175-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a data loader</span></span>
<span id="cb175-17"><a href="#cb175-17" aria-hidden="true" tabindex="-1"></a>test_data_loader <span class="op">=</span> DataLoader(celeba_dataset, batch_size<span class="op">=</span>batch_size, shuffle<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-118" class="cell">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_hypernet(data,hypernet,targetnet,c_idx):</span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a>    pixel_intensity <span class="op">=</span> data.reshape(<span class="dv">3</span>,<span class="op">-</span><span class="dv">1</span>).T.to(device).<span class="bu">float</span>()</span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span> <span class="op">=</span> torch.concatenate([xy[c_idx],pixel_intensity[c_idx]],axis<span class="op">=</span><span class="dv">1</span>).<span class="bu">float</span>()</span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-6"><a href="#cb176-6" aria-hidden="true" tabindex="-1"></a>    hyper_out <span class="op">=</span> hypernet(<span class="bu">input</span>) <span class="co"># hyper_out is a tensor of shape (n_context, total_params)</span></span>
<span id="cb176-7"><a href="#cb176-7" aria-hidden="true" tabindex="-1"></a>    hyper_out <span class="op">=</span> torch.mean(hyper_out,dim<span class="op">=</span><span class="dv">0</span>) <span class="co"># aggregate across context points</span></span>
<span id="cb176-8"><a href="#cb176-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-9"><a href="#cb176-9" aria-hidden="true" tabindex="-1"></a>    target_dict <span class="op">=</span>{}</span>
<span id="cb176-10"><a href="#cb176-10" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb176-11"><a href="#cb176-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name,param <span class="kw">in</span> targetnet.named_parameters():</span>
<span id="cb176-12"><a href="#cb176-12" aria-hidden="true" tabindex="-1"></a>        end <span class="op">=</span> start <span class="op">+</span> param.numel()</span>
<span id="cb176-13"><a href="#cb176-13" aria-hidden="true" tabindex="-1"></a>        target_dict[name] <span class="op">=</span> hyper_out[start:end].reshape(param.shape)</span>
<span id="cb176-14"><a href="#cb176-14" aria-hidden="true" tabindex="-1"></a>        start <span class="op">=</span> end</span>
<span id="cb176-15"><a href="#cb176-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-16"><a href="#cb176-16" aria-hidden="true" tabindex="-1"></a>    img_out <span class="op">=</span> torch.func.functional_call(targetnet, target_dict, xy)</span>
<span id="cb176-17"><a href="#cb176-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> img_out.cpu().detach()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-119" class="cell">
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>c_1 <span class="op">=</span> np.array(random.sample(<span class="bu">range</span>(img_size<span class="op">*</span>img_size),<span class="dv">1</span>))</span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a>c_10 <span class="op">=</span> np.array(random.sample(<span class="bu">range</span>(img_size<span class="op">*</span>img_size),<span class="dv">10</span>))</span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a>c_100 <span class="op">=</span> np.array(random.sample(<span class="bu">range</span>(img_size<span class="op">*</span>img_size),<span class="dv">100</span>))</span>
<span id="cb177-4"><a href="#cb177-4" aria-hidden="true" tabindex="-1"></a>c_1000 <span class="op">=</span> np.array(random.sample(<span class="bu">range</span>(img_size<span class="op">*</span>img_size),<span class="dv">1000</span>))</span>
<span id="cb177-5"><a href="#cb177-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-6"><a href="#cb177-6" aria-hidden="true" tabindex="-1"></a>image_any <span class="op">=</span> test_data_loader.dataset[<span class="dv">0</span>]</span>
<span id="cb177-7"><a href="#cb177-7" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb177-8"><a href="#cb177-8" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> image_any</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-120" class="cell" data-outputid="ceb42031-9d3c-415b-c06a-8bbe6c3d1148">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">9</span>,<span class="dv">7</span>),constrained_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">"HyperNetworks"</span>,fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_image(i,j,k, data,hypernet,targetnet, c_idx):</span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a>    plt.subplot(i,j,k)</span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> data.permute(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">0</span>)</span>
<span id="cb178-6"><a href="#cb178-6" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> np.zeros((<span class="dv">32</span>,<span class="dv">32</span>,<span class="dv">3</span>))</span>
<span id="cb178-7"><a href="#cb178-7" aria-hidden="true" tabindex="-1"></a>    mask[c_idx<span class="op">//</span><span class="dv">32</span>,c_idx<span class="op">%</span><span class="dv">32</span>,:] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb178-8"><a href="#cb178-8" aria-hidden="true" tabindex="-1"></a>    plt.imshow(img<span class="op">*</span>mask)</span>
<span id="cb178-9"><a href="#cb178-9" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f"Context: </span><span class="sc">{</span><span class="bu">len</span>(c_idx)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb178-10"><a href="#cb178-10" aria-hidden="true" tabindex="-1"></a>    plt.axis(<span class="st">'off'</span>)</span>
<span id="cb178-11"><a href="#cb178-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-12"><a href="#cb178-12" aria-hidden="true" tabindex="-1"></a>    plt.subplot(i,j,k<span class="op">+</span><span class="dv">4</span>)</span>
<span id="cb178-13"><a href="#cb178-13" aria-hidden="true" tabindex="-1"></a>    plot_image <span class="op">=</span> plot_hypernet(data,hypernet,targetnet,c_idx)</span>
<span id="cb178-14"><a href="#cb178-14" aria-hidden="true" tabindex="-1"></a>    plt.imshow(plot_image[:,:<span class="dv">3</span>].T.reshape(<span class="dv">3</span>,<span class="dv">32</span>,<span class="dv">32</span>).permute(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">0</span>))</span>
<span id="cb178-15"><a href="#cb178-15" aria-hidden="true" tabindex="-1"></a>    plt.axis(<span class="st">'off'</span>)</span>
<span id="cb178-16"><a href="#cb178-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-17"><a href="#cb178-17" aria-hidden="true" tabindex="-1"></a>    plt.subplot(i,j,k<span class="op">+</span><span class="dv">8</span>)</span>
<span id="cb178-18"><a href="#cb178-18" aria-hidden="true" tabindex="-1"></a>    var <span class="op">=</span>plot_image[:,<span class="dv">3</span>:].exp().T.reshape(<span class="dv">3</span>,<span class="dv">32</span>,<span class="dv">32</span>).permute(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">0</span>)</span>
<span id="cb178-19"><a href="#cb178-19" aria-hidden="true" tabindex="-1"></a>    var <span class="op">=</span> var<span class="op">-</span>var.<span class="bu">min</span>()</span>
<span id="cb178-20"><a href="#cb178-20" aria-hidden="true" tabindex="-1"></a>    var <span class="op">=</span> var<span class="op">/</span>var.<span class="bu">max</span>()</span>
<span id="cb178-21"><a href="#cb178-21" aria-hidden="true" tabindex="-1"></a>    plt.imshow(var)</span>
<span id="cb178-22"><a href="#cb178-22" aria-hidden="true" tabindex="-1"></a>    plt.axis(<span class="st">'off'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 900x700 with 0 Axes&gt;</code></pre>
</div>
</div>
<div id="cell-121" class="cell" data-outputid="fb22ea37-de5b-450b-8799-a8ae553a4932">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a>data.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>torch.Size([3, 32, 32])</code></pre>
</div>
</div>
<div id="cell-122" class="cell" data-outputid="c742ff5a-a141-42b6-c263-23bc975a2778">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>plot_image(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,data,hypernet,targetnet,c_1)</span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a>plot_image(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">2</span>,data,hypernet,targetnet,c_10)</span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a>plot_image(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">3</span>,data,hypernet,targetnet,c_100)</span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a>plot_image(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">4</span>,data,hypernet,targetnet,c_1000)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
/home/jaiswalsuraj/miniconda3/envs/tf_gpu/lib/python3.10/site-packages/matplotlib/cm.py:478: RuntimeWarning: invalid value encountered in cast
  xx = (xx * 255).astype(np.uint8)</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-96-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-15"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-96-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="neural-processes" class="level2">
<h2 class="anchored" data-anchor-id="neural-processes">Neural Processes</h2>
<p>Celeba data <a href="https://mmlab.ie.cuhk.edu.hk/projects/CelebA.html">link</a></p>
<p>Note book ref <a href="">link</a></p>
<section id="loading-and-preprocessing-1" class="level3">
<h3 class="anchored" data-anchor-id="loading-and-preprocessing-1">loading and preprocessing</h3>
<div id="cell-127" class="cell">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">1</span> <span class="co"># keep this to 1</span></span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>img_size <span class="op">=</span> <span class="dv">32</span> <span class="co"># Change as needed</span></span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the root directory where the dataset is located</span></span>
<span id="cb184-5"><a href="#cb184-5" aria-hidden="true" tabindex="-1"></a>data_root <span class="op">=</span> <span class="st">'/home/jaiswalsuraj/suraj_work/projects/data/celeba/img_align_celeba_10000'</span></span>
<span id="cb184-6"><a href="#cb184-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-7"><a href="#cb184-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the data transformations</span></span>
<span id="cb184-8"><a href="#cb184-8" aria-hidden="true" tabindex="-1"></a>transform <span class="op">=</span> transforms.Compose([</span>
<span id="cb184-9"><a href="#cb184-9" aria-hidden="true" tabindex="-1"></a>    transforms.Resize((img_size, img_size)),  <span class="co"># Resize the images to a common size (adjust as needed)</span></span>
<span id="cb184-10"><a href="#cb184-10" aria-hidden="true" tabindex="-1"></a>    transforms.ToTensor(),        <span class="co"># Convert images to tensors</span></span>
<span id="cb184-11"><a href="#cb184-11" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb184-12"><a href="#cb184-12" aria-hidden="true" tabindex="-1"></a><span class="co"># default shape is torch.Size([3, 218, 178])</span></span>
<span id="cb184-13"><a href="#cb184-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the custom dataset</span></span>
<span id="cb184-14"><a href="#cb184-14" aria-hidden="true" tabindex="-1"></a>celeba_dataset <span class="op">=</span> CustomImageDataset(data_root, transform<span class="op">=</span>transform)</span>
<span id="cb184-15"><a href="#cb184-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb184-16"><a href="#cb184-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a data loader</span></span>
<span id="cb184-17"><a href="#cb184-17" aria-hidden="true" tabindex="-1"></a>data_loader <span class="op">=</span> DataLoader(celeba_dataset, batch_size<span class="op">=</span>batch_size, shuffle<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Original image after transformation</p>
<div id="cell-129" class="cell" data-outputid="7cdd46a5-dd92-4be3-e684-3c09635048da">
<div class="sourceCode cell-code" id="cb185"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>plt.imshow(torch.einsum(<span class="st">'chw -&gt; hwc'</span>, data_loader.dataset[<span class="dv">33</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-99-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-16"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-99-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Original image</p>
<div id="cell-131" class="cell" data-outputid="0fabf176-e4f2-42b8-8376-42cb577253ad">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>plt.imshow(torch.einsum(<span class="st">'chw -&gt; hwc'</span>, data_loader.dataset[<span class="dv">33</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;matplotlib.image.AxesImage at 0x7f800aac09d0&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-100-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-17"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-100-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<section id="encoder-decoder-model-defination" class="level4">
<h4 class="anchored" data-anchor-id="encoder-decoder-model-defination">Encoder Decoder model defination</h4>
<div id="cell-133" class="cell">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Encoder(nn.Module):</span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, input_dim, hidden_dim, z_dim,activation<span class="op">=</span>torch.sin,activation_scale<span class="op">=</span><span class="fl">30.0</span>):</span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.activation <span class="op">=</span> activation</span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.activation_scale <span class="op">=</span> activation_scale</span>
<span id="cb188-6"><a href="#cb188-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> activation <span class="op">!=</span> torch.sin:</span>
<span id="cb188-7"><a href="#cb188-7" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.activation_scale <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb188-8"><a href="#cb188-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-9"><a href="#cb188-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.linear1 <span class="op">=</span> nn.Linear(input_dim, hidden_dim)</span>
<span id="cb188-10"><a href="#cb188-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.linear2 <span class="op">=</span> nn.Linear(hidden_dim, hidden_dim)</span>
<span id="cb188-11"><a href="#cb188-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.linear3 <span class="op">=</span> nn.Linear(hidden_dim, z_dim)</span>
<span id="cb188-12"><a href="#cb188-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-13"><a href="#cb188-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb188-14"><a href="#cb188-14" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.activation(<span class="va">self</span>.linear1(x)<span class="op">*</span><span class="va">self</span>.activation_scale)</span>
<span id="cb188-15"><a href="#cb188-15" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.activation(<span class="va">self</span>.linear2(x)<span class="op">*</span><span class="va">self</span>.activation_scale)</span>
<span id="cb188-16"><a href="#cb188-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.linear3(x)</span>
<span id="cb188-17"><a href="#cb188-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-18"><a href="#cb188-18" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Decoder(nn.Module):</span>
<span id="cb188-19"><a href="#cb188-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, z_dim, hidden_dim, output_dim,activation<span class="op">=</span>torch.sin,activation_scale<span class="op">=</span><span class="fl">30.0</span>):</span>
<span id="cb188-20"><a href="#cb188-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb188-21"><a href="#cb188-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.activation <span class="op">=</span> activation</span>
<span id="cb188-22"><a href="#cb188-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.activation_scale <span class="op">=</span> activation_scale</span>
<span id="cb188-23"><a href="#cb188-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> activation <span class="op">!=</span> torch.sin:</span>
<span id="cb188-24"><a href="#cb188-24" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.activation_scale <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb188-25"><a href="#cb188-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.linear1 <span class="op">=</span> nn.Linear(z_dim, hidden_dim)</span>
<span id="cb188-26"><a href="#cb188-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.linear2 <span class="op">=</span> nn.Linear(hidden_dim, hidden_dim)</span>
<span id="cb188-27"><a href="#cb188-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.linear3 <span class="op">=</span> nn.Linear(hidden_dim, hidden_dim)</span>
<span id="cb188-28"><a href="#cb188-28" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.linear4 <span class="op">=</span> nn.Linear(hidden_dim, hidden_dim)</span>
<span id="cb188-29"><a href="#cb188-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.linear5 <span class="op">=</span> nn.Linear(hidden_dim, output_dim)</span>
<span id="cb188-30"><a href="#cb188-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-31"><a href="#cb188-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb188-32"><a href="#cb188-32" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.activation(<span class="va">self</span>.linear1(x)<span class="op">*</span><span class="va">self</span>.activation_scale)</span>
<span id="cb188-33"><a href="#cb188-33" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.activation(<span class="va">self</span>.linear2(x)<span class="op">*</span><span class="va">self</span>.activation_scale)</span>
<span id="cb188-34"><a href="#cb188-34" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.activation(<span class="va">self</span>.linear3(x)<span class="op">*</span><span class="va">self</span>.activation_scale)</span>
<span id="cb188-35"><a href="#cb188-35" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.activation(<span class="va">self</span>.linear4(x)<span class="op">*</span><span class="va">self</span>.activation_scale)</span>
<span id="cb188-36"><a href="#cb188-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.linear5(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-134" class="cell" data-outputid="be10c9c9-763a-413e-a2ca-391c5ff489f6">
<div class="sourceCode cell-code" id="cb189"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchinfo <span class="im">import</span> summary</span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>encoder <span class="op">=</span> Encoder(<span class="dv">5</span>, <span class="dv">256</span>, <span class="dv">128</span>, activation<span class="op">=</span>torch.relu,activation_scale<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a>summary(encoder,input_size<span class="op">=</span>(img_size<span class="op">*</span>img_size,<span class="dv">5</span>)) <span class="co"># 32*32 = 1024 is the image size length, 5 is the input(x,y,r,g,b) to hypernet</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>==========================================================================================
Layer (type:depth-idx)                   Output Shape              Param #
==========================================================================================
Encoder                                  [1024, 128]               --
├─Linear: 1-1                            [1024, 256]               1,536
├─Linear: 1-2                            [1024, 256]               65,792
├─Linear: 1-3                            [1024, 128]               32,896
==========================================================================================
Total params: 100,224
Trainable params: 100,224
Non-trainable params: 0
Total mult-adds (M): 102.63
==========================================================================================
Input size (MB): 0.02
Forward/backward pass size (MB): 5.24
Params size (MB): 0.40
Estimated Total Size (MB): 5.66
==========================================================================================</code></pre>
</div>
</div>
<div id="cell-135" class="cell" data-outputid="84db15f6-df5e-4bc6-b826-4bf659b21b87">
<div class="sourceCode cell-code" id="cb191"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(encoder)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Encoder(
  (linear1): Linear(in_features=5, out_features=256, bias=True)
  (linear2): Linear(in_features=256, out_features=256, bias=True)
  (linear3): Linear(in_features=256, out_features=128, bias=True)
)</code></pre>
</div>
</div>
<div id="cell-136" class="cell" data-outputid="e1b3dbe9-bf87-400b-88e3-4c946ede3b55">
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>decoder <span class="op">=</span> Decoder(<span class="dv">130</span>, <span class="dv">256</span>, <span class="dv">6</span>, activation<span class="op">=</span>torch.relu,activation_scale<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a>summary(decoder,input_size<span class="op">=</span>(img_size<span class="op">*</span>img_size,<span class="dv">130</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<pre><code>==========================================================================================
Layer (type:depth-idx)                   Output Shape              Param #
==========================================================================================
Decoder                                  [1024, 6]                 --
├─Linear: 1-1                            [1024, 256]               33,536
├─Linear: 1-2                            [1024, 256]               65,792
├─Linear: 1-3                            [1024, 256]               65,792
├─Linear: 1-4                            [1024, 256]               65,792
├─Linear: 1-5                            [1024, 6]                 1,542
==========================================================================================
Total params: 232,454
Trainable params: 232,454
Non-trainable params: 0
Total mult-adds (M): 238.03
==========================================================================================
Input size (MB): 0.53
Forward/backward pass size (MB): 8.44
Params size (MB): 0.93
Estimated Total Size (MB): 9.90
==========================================================================================</code></pre>
</div>
</div>
<div id="cell-137" class="cell" data-outputid="afb1176f-37ed-46bb-9a78-4d5d8f4ce1e9">
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(decoder)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Decoder(
  (linear1): Linear(in_features=130, out_features=256, bias=True)
  (linear2): Linear(in_features=256, out_features=256, bias=True)
  (linear3): Linear(in_features=256, out_features=256, bias=True)
  (linear4): Linear(in_features=256, out_features=256, bias=True)
  (linear5): Linear(in_features=256, out_features=6, bias=True)
)</code></pre>
</div>
</div>
</section>
<section id="initialize-the-input-1" class="level4">
<h4 class="anchored" data-anchor-id="initialize-the-input-1">initialize the input</h4>
<div id="cell-139" class="cell" data-outputid="aefe4e0e-1919-423b-b210-31dff8274642">
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>corr, vals <span class="op">=</span> create_coordinate_map(data_loader.dataset[<span class="dv">0</span>])</span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a>corr, vals</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>(tensor([[ 0.,  0.],
         [ 1.,  0.],
         [ 2.,  0.],
         ...,
         [29., 31.],
         [30., 31.],
         [31., 31.]], device='cuda:2'),
 tensor([[0.4510, 0.4706, 0.4824],
         [0.4745, 0.4745, 0.4471],
         [0.4667, 0.4353, 0.5412],
         ...,
         [0.0314, 0.0549, 0.0471],
         [0.0431, 0.0392, 0.0510],
         [0.0549, 0.0392, 0.0549]], device='cuda:2'))</code></pre>
</div>
</div>
<div id="cell-140" class="cell" data-outputid="47a88cd5-5b50-4e84-80f1-cb2508d4e67b">
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>scaler_img <span class="op">=</span> preprocessing.MinMaxScaler().fit(corr.cpu())</span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a>xy <span class="op">=</span> torch.tensor(scaler_img.transform(corr.cpu())).<span class="bu">float</span>().to(device)</span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a>xy, xy.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>(tensor([[0.0000, 0.0000],
         [0.0323, 0.0000],
         [0.0645, 0.0000],
         ...,
         [0.9355, 1.0000],
         [0.9677, 1.0000],
         [1.0000, 1.0000]], device='cuda:2'),
 torch.Size([1024, 2]))</code></pre>
</div>
</div>
</section>
</section>
<section id="training-loop-1" class="level3">
<h3 class="anchored" data-anchor-id="training-loop-1">Training loop</h3>
<div id="cell-142" class="cell" data-outputid="cf4b54cd-44a3-4440-e8f5-5d4a77d28a0b">
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>n_epochs<span class="op">=</span><span class="dv">20</span></span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> <span class="fl">0.003</span></span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a>n_context <span class="op">=</span> <span class="dv">200</span></span>
<span id="cb201-4"><a href="#cb201-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Context Points="</span>,n_context)</span>
<span id="cb201-5"><a href="#cb201-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-6"><a href="#cb201-6" aria-hidden="true" tabindex="-1"></a>encoder <span class="op">=</span> Encoder(input_dim<span class="op">=</span><span class="dv">5</span>, hidden_dim<span class="op">=</span><span class="dv">512</span>, z_dim<span class="op">=</span><span class="dv">128</span>,activation<span class="op">=</span>torch.relu,activation_scale<span class="op">=</span><span class="dv">1</span>).to(device)</span>
<span id="cb201-7"><a href="#cb201-7" aria-hidden="true" tabindex="-1"></a>decoder <span class="op">=</span> Decoder(z_dim<span class="op">=</span><span class="dv">130</span>, hidden_dim<span class="op">=</span><span class="dv">512</span>, output_dim<span class="op">=</span><span class="dv">6</span>,activation<span class="op">=</span>torch.relu,activation_scale<span class="op">=</span><span class="dv">1</span>).to(device)</span>
<span id="cb201-8"><a href="#cb201-8" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> optim.Adam(<span class="bu">list</span>(encoder.parameters())<span class="op">+</span><span class="bu">list</span>(decoder.parameters()),lr<span class="op">=</span>lr)</span>
<span id="cb201-9"><a href="#cb201-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-10"><a href="#cb201-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> epoch <span class="kw">in</span> trange(n_epochs):</span>
<span id="cb201-11"><a href="#cb201-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-12"><a href="#cb201-12" aria-hidden="true" tabindex="-1"></a>    c_idx <span class="op">=</span> np.array(random.sample(<span class="bu">range</span>(<span class="dv">1023</span>),n_context))</span>
<span id="cb201-13"><a href="#cb201-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-14"><a href="#cb201-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Epoch="</span>,epoch<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb201-15"><a href="#cb201-15" aria-hidden="true" tabindex="-1"></a>    epoch_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb201-16"><a href="#cb201-16" aria-hidden="true" tabindex="-1"></a>    i<span class="op">=</span><span class="dv">1</span></span>
<span id="cb201-17"><a href="#cb201-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> data <span class="kw">in</span> data_loader:</span>
<span id="cb201-18"><a href="#cb201-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(data.shape)</span></span>
<span id="cb201-19"><a href="#cb201-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-20"><a href="#cb201-20" aria-hidden="true" tabindex="-1"></a>        optimizer.zero_grad()</span>
<span id="cb201-21"><a href="#cb201-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-22"><a href="#cb201-22" aria-hidden="true" tabindex="-1"></a>        pixel_intensity <span class="op">=</span> data.reshape(<span class="dv">3</span>,<span class="op">-</span><span class="dv">1</span>).T.to(device).<span class="bu">float</span>()</span>
<span id="cb201-23"><a href="#cb201-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">input</span> <span class="op">=</span> torch.concatenate([xy[c_idx],pixel_intensity[c_idx]],axis<span class="op">=</span><span class="dv">1</span>).<span class="bu">float</span>()</span>
<span id="cb201-24"><a href="#cb201-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-25"><a href="#cb201-25" aria-hidden="true" tabindex="-1"></a>        encoder_out <span class="op">=</span> encoder(<span class="bu">input</span>)</span>
<span id="cb201-26"><a href="#cb201-26" aria-hidden="true" tabindex="-1"></a>        encoder_out <span class="op">=</span> torch.mean(encoder_out,dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb201-27"><a href="#cb201-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-28"><a href="#cb201-28" aria-hidden="true" tabindex="-1"></a>        decoder_in <span class="op">=</span> encoder_out.repeat(<span class="dv">1024</span>,<span class="dv">1</span>)</span>
<span id="cb201-29"><a href="#cb201-29" aria-hidden="true" tabindex="-1"></a>        decoder_in <span class="op">=</span> torch.concatenate([xy,decoder_in],axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb201-30"><a href="#cb201-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-31"><a href="#cb201-31" aria-hidden="true" tabindex="-1"></a>        img_out <span class="op">=</span> decoder(decoder_in)</span>
<span id="cb201-32"><a href="#cb201-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-33"><a href="#cb201-33" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> neg_loglikelyhood(img_out[:,:<span class="dv">3</span>],img_out[:,<span class="dv">3</span>:],pixel_intensity)</span>
<span id="cb201-34"><a href="#cb201-34" aria-hidden="true" tabindex="-1"></a>        loss.backward()</span>
<span id="cb201-35"><a href="#cb201-35" aria-hidden="true" tabindex="-1"></a>        optimizer.step()</span>
<span id="cb201-36"><a href="#cb201-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-37"><a href="#cb201-37" aria-hidden="true" tabindex="-1"></a>        epoch_loss <span class="op">=</span> epoch_loss <span class="op">+</span> loss.item()</span>
<span id="cb201-38"><a href="#cb201-38" aria-hidden="true" tabindex="-1"></a>        i<span class="op">=</span>i<span class="op">+</span><span class="dv">1</span></span>
<span id="cb201-39"><a href="#cb201-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Epoch Loss="</span>,epoch_loss<span class="op">/</span><span class="bu">len</span>(data_loader))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Context Points= 200</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  0%|          | 0/20 [00:00&lt;?, ?it/s]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch= 1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  5%|▌         | 1/20 [00:58&lt;18:27, 58.30s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= 47.26116828255653
Epoch= 2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 10%|█         | 2/20 [01:50&lt;16:27, 54.89s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -455.4421627301693
Epoch= 3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 15%|█▌        | 3/20 [02:43&lt;15:16, 53.92s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -683.1707640041351
Epoch= 4</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 20%|██        | 4/20 [03:35&lt;14:13, 53.32s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -761.2885692318916
Epoch= 5</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 25%|██▌       | 5/20 [04:36&lt;13:56, 55.78s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -827.9153870079041
Epoch= 6</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 30%|███       | 6/20 [05:35&lt;13:20, 57.17s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -938.4062066322326
Epoch= 7</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 35%|███▌      | 7/20 [06:30&lt;12:11, 56.24s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1007.5277942465782
Epoch= 8</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 40%|████      | 8/20 [07:30&lt;11:28, 57.39s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1048.726986592865
Epoch= 9</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 45%|████▌     | 9/20 [08:20&lt;10:06, 55.15s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1057.8311284263611
Epoch= 10</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 50%|█████     | 10/20 [09:17&lt;09:17, 55.74s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1070.1760208235742
Epoch= 11</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 55%|█████▌    | 11/20 [09:56&lt;07:34, 50.50s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1065.5062245418549
Epoch= 12</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 60%|██████    | 12/20 [10:35&lt;06:16, 47.06s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1078.0465439793586
Epoch= 13</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 65%|██████▌   | 13/20 [11:14&lt;05:13, 44.75s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1088.4120592634201
Epoch= 14</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 70%|███████   | 14/20 [11:53&lt;04:17, 42.99s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1078.4957633354188
Epoch= 15</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 75%|███████▌  | 15/20 [12:32&lt;03:28, 41.78s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1084.8360796244622
Epoch= 16</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 80%|████████  | 16/20 [13:11&lt;02:43, 40.94s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1093.4410486424447
Epoch= 17</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 85%|████████▌ | 17/20 [13:50&lt;02:01, 40.44s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1113.8205106693267
Epoch= 18</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 90%|█████████ | 18/20 [14:29&lt;01:19, 39.99s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1110.6333978479386
Epoch= 19</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code> 95%|█████████▌| 19/20 [15:25&lt;00:44, 44.66s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1098.3281953195572
Epoch= 20</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 20/20 [16:25&lt;00:00, 49.28s/it]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch Loss= -1106.2516599431992</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
</div>
</section>
<section id="saving-and-loading-the-model-1" class="level3">
<h3 class="anchored" data-anchor-id="saving-and-loading-the-model-1">saving and loading the model</h3>
<div id="cell-144" class="cell">
<div class="sourceCode cell-code" id="cb246"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a>torch.save(encoder.state_dict(), <span class="st">'encoder_model_10000.pth'</span>)</span>
<span id="cb246-2"><a href="#cb246-2" aria-hidden="true" tabindex="-1"></a>torch.save(decoder.state_dict(), <span class="st">'decoder_model_10000.pth'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-145" class="cell" data-outputid="5b162670-6fc1-4702-bf44-a388582cf6b9">
<div class="sourceCode cell-code" id="cb247"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the hypernet and targetnet models</span></span>
<span id="cb247-2"><a href="#cb247-2" aria-hidden="true" tabindex="-1"></a>encoder <span class="op">=</span> Encoder(input_dim<span class="op">=</span><span class="dv">5</span>, hidden_dim<span class="op">=</span><span class="dv">128</span>, z_dim<span class="op">=</span><span class="dv">128</span>,activation<span class="op">=</span>torch.relu,activation_scale<span class="op">=</span><span class="dv">1</span>).to(device)</span>
<span id="cb247-3"><a href="#cb247-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-4"><a href="#cb247-4" aria-hidden="true" tabindex="-1"></a>encoder.load_state_dict(torch.load(<span class="st">'encoder_model_10000.pth'</span>))</span>
<span id="cb247-5"><a href="#cb247-5" aria-hidden="true" tabindex="-1"></a>encoder.<span class="bu">eval</span>()  <span class="co"># Set the model to evaluation mode</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>Encoder(
  (linear1): Linear(in_features=5, out_features=128, bias=True)
  (linear2): Linear(in_features=128, out_features=128, bias=True)
  (linear3): Linear(in_features=128, out_features=128, bias=True)
)</code></pre>
</div>
</div>
<div id="cell-146" class="cell" data-outputid="6b6da0db-099d-4f6c-99cf-dd32d60b5488">
<div class="sourceCode cell-code" id="cb249"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a>decoder <span class="op">=</span> Decoder(z_dim<span class="op">=</span><span class="dv">130</span>, hidden_dim<span class="op">=</span><span class="dv">256</span>, output_dim<span class="op">=</span><span class="dv">6</span>,activation<span class="op">=</span>torch.relu,activation_scale<span class="op">=</span><span class="dv">1</span>).to(device)</span>
<span id="cb249-2"><a href="#cb249-2" aria-hidden="true" tabindex="-1"></a>decoder.load_state_dict(torch.load(<span class="st">'decoder_model_10000.pth'</span>))</span>
<span id="cb249-3"><a href="#cb249-3" aria-hidden="true" tabindex="-1"></a>decoder.<span class="bu">eval</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>Decoder(
  (linear1): Linear(in_features=130, out_features=256, bias=True)
  (linear2): Linear(in_features=256, out_features=256, bias=True)
  (linear3): Linear(in_features=256, out_features=256, bias=True)
  (linear4): Linear(in_features=256, out_features=256, bias=True)
  (linear5): Linear(in_features=256, out_features=6, bias=True)
)</code></pre>
</div>
</div>
</section>
<section id="plots-1" class="level3">
<h3 class="anchored" data-anchor-id="plots-1">Plots</h3>
<p>Loading the test data</p>
<div id="cell-149" class="cell">
<div class="sourceCode cell-code" id="cb251"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">1</span> <span class="co"># keep this to 1</span></span>
<span id="cb251-2"><a href="#cb251-2" aria-hidden="true" tabindex="-1"></a>img_size <span class="op">=</span> <span class="dv">32</span> <span class="co"># Change as needed</span></span>
<span id="cb251-3"><a href="#cb251-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb251-4"><a href="#cb251-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the root directory where the dataset is located</span></span>
<span id="cb251-5"><a href="#cb251-5" aria-hidden="true" tabindex="-1"></a>data_root <span class="op">=</span> <span class="st">'/home/jaiswalsuraj/suraj_work/projects/data/celeba/img_align_celeba_2599'</span></span>
<span id="cb251-6"><a href="#cb251-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb251-7"><a href="#cb251-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the data transformations</span></span>
<span id="cb251-8"><a href="#cb251-8" aria-hidden="true" tabindex="-1"></a>transform <span class="op">=</span> transforms.Compose([</span>
<span id="cb251-9"><a href="#cb251-9" aria-hidden="true" tabindex="-1"></a>    transforms.Resize((img_size, img_size)),  <span class="co"># Resize the images to a common size (adjust as needed)</span></span>
<span id="cb251-10"><a href="#cb251-10" aria-hidden="true" tabindex="-1"></a>    transforms.ToTensor(),   <span class="co"># Convert images to tensors</span></span>
<span id="cb251-11"><a href="#cb251-11" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb251-12"><a href="#cb251-12" aria-hidden="true" tabindex="-1"></a><span class="co"># default shape is torch.Size([3, 218, 178])</span></span>
<span id="cb251-13"><a href="#cb251-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the custom dataset</span></span>
<span id="cb251-14"><a href="#cb251-14" aria-hidden="true" tabindex="-1"></a>celeba_dataset <span class="op">=</span> CustomImageDataset(data_root, transform<span class="op">=</span>transform)</span>
<span id="cb251-15"><a href="#cb251-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb251-16"><a href="#cb251-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a data loader</span></span>
<span id="cb251-17"><a href="#cb251-17" aria-hidden="true" tabindex="-1"></a>test_data_loader <span class="op">=</span> DataLoader(celeba_dataset, batch_size<span class="op">=</span>batch_size, shuffle<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-150" class="cell">
<div class="sourceCode cell-code" id="cb252"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_enc_dec(data,encoder,decoder,c_idx):</span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-3"><a href="#cb252-3" aria-hidden="true" tabindex="-1"></a>    pixel_intensity <span class="op">=</span> data.reshape(<span class="dv">3</span>,<span class="op">-</span><span class="dv">1</span>).T.to(device).<span class="bu">float</span>()</span>
<span id="cb252-4"><a href="#cb252-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span> <span class="op">=</span> torch.concatenate([xy[c_idx],pixel_intensity[c_idx]],axis<span class="op">=</span><span class="dv">1</span>).<span class="bu">float</span>()</span>
<span id="cb252-5"><a href="#cb252-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-6"><a href="#cb252-6" aria-hidden="true" tabindex="-1"></a>    encoder_out <span class="op">=</span> encoder(<span class="bu">input</span>)</span>
<span id="cb252-7"><a href="#cb252-7" aria-hidden="true" tabindex="-1"></a>    encoder_out <span class="op">=</span> torch.mean(encoder_out,dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb252-8"><a href="#cb252-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-9"><a href="#cb252-9" aria-hidden="true" tabindex="-1"></a>    decoder_in <span class="op">=</span> encoder_out.repeat(<span class="dv">1024</span>,<span class="dv">1</span>)</span>
<span id="cb252-10"><a href="#cb252-10" aria-hidden="true" tabindex="-1"></a>    decoder_in <span class="op">=</span> torch.concatenate([xy,decoder_in],axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb252-11"><a href="#cb252-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-12"><a href="#cb252-12" aria-hidden="true" tabindex="-1"></a>    img_out <span class="op">=</span> decoder(decoder_in)</span>
<span id="cb252-13"><a href="#cb252-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> img_out.cpu().detach()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-151" class="cell">
<div class="sourceCode cell-code" id="cb253"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a>c_1 <span class="op">=</span> np.array(random.sample(<span class="bu">range</span>(img_size<span class="op">*</span>img_size),<span class="dv">1</span>))</span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a>c_10 <span class="op">=</span> np.array(random.sample(<span class="bu">range</span>(img_size<span class="op">*</span>img_size),<span class="dv">10</span>))</span>
<span id="cb253-3"><a href="#cb253-3" aria-hidden="true" tabindex="-1"></a>c_100 <span class="op">=</span> np.array(random.sample(<span class="bu">range</span>(img_size<span class="op">*</span>img_size),<span class="dv">100</span>))</span>
<span id="cb253-4"><a href="#cb253-4" aria-hidden="true" tabindex="-1"></a>c_1000 <span class="op">=</span> np.array(random.sample(<span class="bu">range</span>(img_size<span class="op">*</span>img_size),<span class="dv">1000</span>))</span>
<span id="cb253-5"><a href="#cb253-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb253-6"><a href="#cb253-6" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb253-7"><a href="#cb253-7" aria-hidden="true" tabindex="-1"></a>image_any <span class="op">=</span> test_data_loader.dataset[idx]</span>
<span id="cb253-8"><a href="#cb253-8" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> image_any</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-152" class="cell" data-outputid="2f293ec1-4fe9-4a2b-91f1-0fbfee4718c4">
<div class="sourceCode cell-code" id="cb254"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">9</span>,<span class="dv">7</span>),constrained_layout<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">"Neural process"</span>,fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb254-3"><a href="#cb254-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_image(i,j,k, data,encoder,decoder, c_idx):</span>
<span id="cb254-4"><a href="#cb254-4" aria-hidden="true" tabindex="-1"></a>    plt.subplot(i,j,k)</span>
<span id="cb254-5"><a href="#cb254-5" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> data.permute(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">0</span>)</span>
<span id="cb254-6"><a href="#cb254-6" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> np.zeros((<span class="dv">32</span>,<span class="dv">32</span>,<span class="dv">3</span>))</span>
<span id="cb254-7"><a href="#cb254-7" aria-hidden="true" tabindex="-1"></a>    mask[c_idx<span class="op">//</span><span class="dv">32</span>,c_idx<span class="op">%</span><span class="dv">32</span>,:] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb254-8"><a href="#cb254-8" aria-hidden="true" tabindex="-1"></a>    plt.imshow(img<span class="op">*</span>mask)</span>
<span id="cb254-9"><a href="#cb254-9" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f"Context: </span><span class="sc">{</span><span class="bu">len</span>(c_idx)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb254-10"><a href="#cb254-10" aria-hidden="true" tabindex="-1"></a>    plt.axis(<span class="st">'off'</span>)</span>
<span id="cb254-11"><a href="#cb254-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-12"><a href="#cb254-12" aria-hidden="true" tabindex="-1"></a>    plt.subplot(i,j,k<span class="op">+</span><span class="dv">4</span>)</span>
<span id="cb254-13"><a href="#cb254-13" aria-hidden="true" tabindex="-1"></a>    plot_image <span class="op">=</span> plot_enc_dec(data,encoder,decoder,c_idx)</span>
<span id="cb254-14"><a href="#cb254-14" aria-hidden="true" tabindex="-1"></a>    plt.imshow(plot_image[:,:<span class="dv">3</span>].T.reshape(<span class="dv">3</span>,<span class="dv">32</span>,<span class="dv">32</span>).permute(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">0</span>))</span>
<span id="cb254-15"><a href="#cb254-15" aria-hidden="true" tabindex="-1"></a>    plt.axis(<span class="st">'off'</span>)</span>
<span id="cb254-16"><a href="#cb254-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-17"><a href="#cb254-17" aria-hidden="true" tabindex="-1"></a>    plt.subplot(i,j,k<span class="op">+</span><span class="dv">8</span>)</span>
<span id="cb254-18"><a href="#cb254-18" aria-hidden="true" tabindex="-1"></a>    var <span class="op">=</span>plot_image[:,<span class="dv">3</span>:].exp().T.reshape(<span class="dv">3</span>,<span class="dv">32</span>,<span class="dv">32</span>).permute(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">0</span>)</span>
<span id="cb254-19"><a href="#cb254-19" aria-hidden="true" tabindex="-1"></a>    var <span class="op">=</span> var<span class="op">-</span>var.<span class="bu">min</span>()</span>
<span id="cb254-20"><a href="#cb254-20" aria-hidden="true" tabindex="-1"></a>    var <span class="op">=</span> var<span class="op">/</span>var.<span class="bu">max</span>()</span>
<span id="cb254-21"><a href="#cb254-21" aria-hidden="true" tabindex="-1"></a>    plt.imshow(var)</span>
<span id="cb254-22"><a href="#cb254-22" aria-hidden="true" tabindex="-1"></a>    plt.axis(<span class="st">'off'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;Figure size 900x700 with 0 Axes&gt;</code></pre>
</div>
</div>
<div id="cell-153" class="cell" data-outputid="16ed8c46-60fc-47a1-b6a4-f1f4e6e364a6">
<div class="sourceCode cell-code" id="cb256"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb256-1"><a href="#cb256-1" aria-hidden="true" tabindex="-1"></a>plot_image(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">1</span>,data,encoder,decoder,c_1)</span>
<span id="cb256-2"><a href="#cb256-2" aria-hidden="true" tabindex="-1"></a>plot_image(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">2</span>,data,encoder,decoder,c_10)</span>
<span id="cb256-3"><a href="#cb256-3" aria-hidden="true" tabindex="-1"></a>plot_image(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">3</span>,data,encoder,decoder,c_100)</span>
<span id="cb256-4"><a href="#cb256-4" aria-hidden="true" tabindex="-1"></a>plot_image(<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">4</span>,data,encoder,decoder,c_1000)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).
Clipping input data to the valid range for imshow with RGB data ([0..1] for floats or [0..255] for integers).</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-116-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-18"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-116-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="question-4." class="level1">
<h1>Question 4.</h1>
<p>Write the Random walk Metropolis Hastings algorithms from scratch. Take 1000 samples using below given log probs and compare the mean and covariance matrix with hamiltorch’s standard HMC and emcee’s Metropolis Hastings implementation. Use 500 samples as the burn/warm up samples. Also check the relation between acceptance ratio and the sigma of the proposal distribution in your from scratch implementation. Use the log likelihood function given below.</p>
<pre class="python3"><code>import torch.distributions as D
def log_likelihood(omega):
    omega = torch.tensor(omega)
    mean = torch.tensor([0., 0.])
    stddev = torch.tensor([0.5, 1.])
    return D.MultivariateNormal(mean, torch.diag(stddev**2)).log_prob(omega).sum()</code></pre>
<div id="cell-156" class="cell">
<div class="sourceCode cell-code" id="cb259"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.distributions <span class="im">as</span> D</span>
<span id="cb259-2"><a href="#cb259-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-3"><a href="#cb259-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-4"><a href="#cb259-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> log_likelihood(omega):</span>
<span id="cb259-5"><a href="#cb259-5" aria-hidden="true" tabindex="-1"></a>    mean <span class="op">=</span> torch.tensor([<span class="fl">0.</span>, <span class="fl">0.</span>])</span>
<span id="cb259-6"><a href="#cb259-6" aria-hidden="true" tabindex="-1"></a>    stddev <span class="op">=</span> torch.tensor([<span class="fl">0.5</span>, <span class="fl">1.</span>])</span>
<span id="cb259-7"><a href="#cb259-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> D.MultivariateNormal(mean, torch.diag(stddev<span class="op">**</span><span class="dv">2</span>)).log_prob(omega).<span class="bu">sum</span>()</span>
<span id="cb259-8"><a href="#cb259-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-9"><a href="#cb259-9" aria-hidden="true" tabindex="-1"></a><span class="co">#Numpy implementation for emcee</span></span>
<span id="cb259-10"><a href="#cb259-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> logprob(omega):</span>
<span id="cb259-11"><a href="#cb259-11" aria-hidden="true" tabindex="-1"></a>    mean <span class="op">=</span> np.array([<span class="fl">0.0</span>, <span class="fl">0.0</span>])</span>
<span id="cb259-12"><a href="#cb259-12" aria-hidden="true" tabindex="-1"></a>    stddev <span class="op">=</span> np.array([<span class="fl">0.5</span>, <span class="fl">1.0</span>])</span>
<span id="cb259-13"><a href="#cb259-13" aria-hidden="true" tabindex="-1"></a>    cov_matrix <span class="op">=</span> np.diag(stddev<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb259-14"><a href="#cb259-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> np.log(<span class="dv">2</span> <span class="op">*</span> np.pi) <span class="op">*</span> <span class="dv">2</span> <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> np.<span class="bu">sum</span>((omega <span class="op">-</span> mean) <span class="op">*</span> np.linalg.solve(cov_matrix, (omega <span class="op">-</span> mean).T), axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb259-15"><a href="#cb259-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb259-16"><a href="#cb259-16" aria-hidden="true" tabindex="-1"></a><span class="co">#Pytorch implementation for hamiltorch</span></span>
<span id="cb259-17"><a href="#cb259-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> logprob_tensor(omega):</span>
<span id="cb259-18"><a href="#cb259-18" aria-hidden="true" tabindex="-1"></a>    mean <span class="op">=</span> torch.tensor([<span class="fl">0.0</span>, <span class="fl">0.0</span>])</span>
<span id="cb259-19"><a href="#cb259-19" aria-hidden="true" tabindex="-1"></a>    stddev <span class="op">=</span> torch.tensor([<span class="fl">0.5</span>, <span class="fl">1.0</span>])</span>
<span id="cb259-20"><a href="#cb259-20" aria-hidden="true" tabindex="-1"></a>    cov_matrix <span class="op">=</span> torch.diag(stddev<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb259-21"><a href="#cb259-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> torch.log(torch.tensor(<span class="dv">2</span> <span class="op">*</span> torch.pi)) <span class="op">*</span> <span class="dv">2</span> <span class="op">-</span> <span class="fl">0.5</span> <span class="op">*</span> torch.<span class="bu">sum</span>((omega <span class="op">-</span> mean) <span class="op">*</span> torch.inverse(cov_matrix) <span class="op">@</span> (omega <span class="op">-</span> mean).T, axis<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-157" class="cell">
<div class="sourceCode cell-code" id="cb260"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> random_walk_metropolis_hastings(log_likelihood, initial_state, num_samples, proposal_stddev):</span>
<span id="cb260-2"><a href="#cb260-2" aria-hidden="true" tabindex="-1"></a>    samples <span class="op">=</span> [initial_state]</span>
<span id="cb260-3"><a href="#cb260-3" aria-hidden="true" tabindex="-1"></a>    accepted_samples <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb260-4"><a href="#cb260-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-5"><a href="#cb260-5" aria-hidden="true" tabindex="-1"></a>    current_state <span class="op">=</span> initial_state</span>
<span id="cb260-6"><a href="#cb260-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(num_samples):</span>
<span id="cb260-7"><a href="#cb260-7" aria-hidden="true" tabindex="-1"></a>        proposal <span class="op">=</span> current_state <span class="op">+</span> proposal_stddev <span class="op">*</span> torch.randn(<span class="op">*</span>(current_state.shape))</span>
<span id="cb260-8"><a href="#cb260-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-9"><a href="#cb260-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate the log-likelihood of the proposal</span></span>
<span id="cb260-10"><a href="#cb260-10" aria-hidden="true" tabindex="-1"></a>        log_likelihood_proposal <span class="op">=</span> log_likelihood(proposal)</span>
<span id="cb260-11"><a href="#cb260-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-12"><a href="#cb260-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate the log-likelihood of the current state</span></span>
<span id="cb260-13"><a href="#cb260-13" aria-hidden="true" tabindex="-1"></a>        log_likelihood_current <span class="op">=</span> log_likelihood(current_state)</span>
<span id="cb260-14"><a href="#cb260-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-15"><a href="#cb260-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate the acceptance ratio</span></span>
<span id="cb260-16"><a href="#cb260-16" aria-hidden="true" tabindex="-1"></a>        acceptance_ratio <span class="op">=</span> log_likelihood_proposal <span class="op">-</span> log_likelihood_current</span>
<span id="cb260-17"><a href="#cb260-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-18"><a href="#cb260-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate the proposal distribution probability (it's a normal distribution)</span></span>
<span id="cb260-19"><a href="#cb260-19" aria-hidden="true" tabindex="-1"></a>        proposal_distribution <span class="op">=</span> D.Normal(current_state, proposal_stddev)</span>
<span id="cb260-20"><a href="#cb260-20" aria-hidden="true" tabindex="-1"></a>        proposal_prob <span class="op">=</span> proposal_distribution.log_prob(proposal)</span>
<span id="cb260-21"><a href="#cb260-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-22"><a href="#cb260-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Accept or reject the proposal</span></span>
<span id="cb260-23"><a href="#cb260-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># acceptance_ratio += proposal_prob - log_likelihood_proposal  # Include the proposal distribution</span></span>
<span id="cb260-24"><a href="#cb260-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> torch.log(D.uniform.Uniform(<span class="dv">0</span>, <span class="dv">1</span>).sample()) <span class="op">&lt;=</span> acceptance_ratio:</span>
<span id="cb260-25"><a href="#cb260-25" aria-hidden="true" tabindex="-1"></a>            current_state <span class="op">=</span> proposal</span>
<span id="cb260-26"><a href="#cb260-26" aria-hidden="true" tabindex="-1"></a>            accepted_samples <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb260-27"><a href="#cb260-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-28"><a href="#cb260-28" aria-hidden="true" tabindex="-1"></a>        samples.append(current_state)</span>
<span id="cb260-29"><a href="#cb260-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-30"><a href="#cb260-30" aria-hidden="true" tabindex="-1"></a>    acceptance_rate <span class="op">=</span> accepted_samples <span class="op">/</span> num_samples</span>
<span id="cb260-31"><a href="#cb260-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> torch.stack(samples), acceptance_rate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-158" class="cell">
<div class="sourceCode cell-code" id="cb261"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the initial state and proposal standard deviation</span></span>
<span id="cb261-2"><a href="#cb261-2" aria-hidden="true" tabindex="-1"></a>initial_state <span class="op">=</span> torch.tensor([<span class="fl">0.0001</span>, <span class="fl">0.0001</span>])</span>
<span id="cb261-3"><a href="#cb261-3" aria-hidden="true" tabindex="-1"></a>proposal_stddev <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb261-4"><a href="#cb261-4" aria-hidden="true" tabindex="-1"></a>num_samples <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb261-5"><a href="#cb261-5" aria-hidden="true" tabindex="-1"></a>burn_in_samples <span class="op">=</span> <span class="dv">500</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-159" class="cell" data-outputid="9b4129e1-a186-45bd-e9b1-6eeb89c80518">
<div class="sourceCode cell-code" id="cb262"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate samples using the RWMH algorithm</span></span>
<span id="cb262-2"><a href="#cb262-2" aria-hidden="true" tabindex="-1"></a>samples,  acceptance_rate <span class="op">=</span> random_walk_metropolis_hastings(log_likelihood, initial_state, num_samples, proposal_stddev)</span>
<span id="cb262-3"><a href="#cb262-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-4"><a href="#cb262-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Discard the burn-in samples</span></span>
<span id="cb262-5"><a href="#cb262-5" aria-hidden="true" tabindex="-1"></a>burned_samples <span class="op">=</span> samples[burn_in_samples:]</span>
<span id="cb262-6"><a href="#cb262-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-7"><a href="#cb262-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-8"><a href="#cb262-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate mean and covariance matrix</span></span>
<span id="cb262-9"><a href="#cb262-9" aria-hidden="true" tabindex="-1"></a>mean <span class="op">=</span> burned_samples.mean(dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb262-10"><a href="#cb262-10" aria-hidden="true" tabindex="-1"></a>covariance_matrix <span class="op">=</span> torch.matmul((burned_samples <span class="op">-</span> mean).T, (burned_samples <span class="op">-</span> mean)) <span class="op">/</span> (burned_samples.size(<span class="dv">0</span>) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb262-11"><a href="#cb262-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-12"><a href="#cb262-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-13"><a href="#cb262-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-14"><a href="#cb262-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"RWMH Acceptance Rate:"</span>, acceptance_rate)</span>
<span id="cb262-15"><a href="#cb262-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"RWMH Mean:"</span>, mean)</span>
<span id="cb262-16"><a href="#cb262-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"RWMH Covariance Matrix:"</span>, covariance_matrix)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RWMH Acceptance Rate: 0.385
RWMH Mean: tensor([ 0.0767, -0.0569])
RWMH Covariance Matrix: tensor([[ 0.2547, -0.0530],
        [-0.0530,  0.8120]])</code></pre>
</div>
</div>
<div id="cell-160" class="cell" data-outputid="595cc874-758c-4d5a-e24c-b13cd90aea5e">
<div class="sourceCode cell-code" id="cb264"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the samples</span></span>
<span id="cb264-2"><a href="#cb264-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb264-3"><a href="#cb264-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb264-4"><a href="#cb264-4" aria-hidden="true" tabindex="-1"></a>plt.plot( np.linspace(<span class="dv">0</span>, burned_samples.size(<span class="dv">0</span>), burned_samples.size(<span class="dv">0</span>)),burned_samples.numpy()[:, <span class="dv">0</span>], label<span class="op">=</span><span class="st">"Samples"</span>)</span>
<span id="cb264-5"><a href="#cb264-5" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb264-6"><a href="#cb264-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Samples from the RWMH algorithm"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="245">
<pre><code>Text(0.5, 1.0, 'Samples from the RWMH algorithm')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-122-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-19"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-122-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-161" class="cell" data-outputid="ab4cbcae-c6a3-4878-cb7d-07e72dee052b">
<div class="sourceCode cell-code" id="cb266"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb266-1"><a href="#cb266-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the KDE of the burned samples</span></span>
<span id="cb266-2"><a href="#cb266-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb266-3"><a href="#cb266-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb266-4"><a href="#cb266-4" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(burned_samples.numpy()[:, <span class="dv">0</span>], fill<span class="op">=</span><span class="va">True</span>, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="st">"KDE of scratch algorithm"</span>)</span>
<span id="cb266-5"><a href="#cb266-5" aria-hidden="true" tabindex="-1"></a>plt.axvline(mean[<span class="dv">0</span>], color<span class="op">=</span><span class="st">"red"</span>, label<span class="op">=</span><span class="st">"Mean"</span>)</span>
<span id="cb266-6"><a href="#cb266-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-7"><a href="#cb266-7" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Parameter 1'</span>)</span>
<span id="cb266-8"><a href="#cb266-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Density'</span>)</span>
<span id="cb266-9"><a href="#cb266-9" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'KDE of Burned Samples'</span>)</span>
<span id="cb266-10"><a href="#cb266-10" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb266-11"><a href="#cb266-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-123-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-20"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-123-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Correlation between acceptance ratio and the sigma of the proposal distribution</p>
<div id="cell-163" class="cell" data-outputid="436b3516-5e0c-42de-8a63-e5a44eac5c46">
<div class="sourceCode cell-code" id="cb267"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tqdm</span>
<span id="cb267-2"><a href="#cb267-2" aria-hidden="true" tabindex="-1"></a>prop_stdev_list <span class="op">=</span> [<span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">10</span>]</span>
<span id="cb267-3"><a href="#cb267-3" aria-hidden="true" tabindex="-1"></a>acceptance_rates <span class="op">=</span> []</span>
<span id="cb267-4"><a href="#cb267-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-5"><a href="#cb267-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> prop_stdev <span class="kw">in</span> tqdm.tqdm(prop_stdev_list):</span>
<span id="cb267-6"><a href="#cb267-6" aria-hidden="true" tabindex="-1"></a>    _, acceptance_rate <span class="op">=</span> random_walk_metropolis_hastings(log_likelihood, initial_state, num_samples, prop_stdev)</span>
<span id="cb267-7"><a href="#cb267-7" aria-hidden="true" tabindex="-1"></a>    acceptance_rates.append(acceptance_rate)</span>
<span id="cb267-8"><a href="#cb267-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-9"><a href="#cb267-9" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb267-10"><a href="#cb267-10" aria-hidden="true" tabindex="-1"></a>plt.plot(prop_stdev_list, acceptance_rates, marker<span class="op">=</span><span class="st">'o'</span>)</span>
<span id="cb267-11"><a href="#cb267-11" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Proposal Standard Deviation"</span>)</span>
<span id="cb267-12"><a href="#cb267-12" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Acceptance Rate"</span>)</span>
<span id="cb267-13"><a href="#cb267-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Acceptance Rate vs. Proposal Standard Deviation"</span>)</span>
<span id="cb267-14"><a href="#cb267-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>  0%|          | 0/6 [00:00&lt;?, ?it/s]100%|██████████| 6/6 [00:15&lt;00:00,  2.63s/it]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-124-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-21"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-124-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>As the sigma of the proposal distribution increases, the acceptance ratio decreases. This is because the proposal distribution is more spread out and the probability of the new sample being accepted is lower. When the sigma is low, we are always sampling from a small region around the current sample and the probability of the new sample being accepted is higher.</p>
<div id="cell-165" class="cell" data-outputid="aa0199b9-8032-48da-f728-5b29185882dd">
<div class="sourceCode cell-code" id="cb269"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a><span class="co"># np.random.seed(93284)</span></span>
<span id="cb269-2"><a href="#cb269-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> emcee</span>
<span id="cb269-3"><a href="#cb269-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb269-4"><a href="#cb269-4" aria-hidden="true" tabindex="-1"></a>init <span class="op">=</span> np.array([[<span class="fl">0.000001</span>], [<span class="fl">0.000002</span>]])</span>
<span id="cb269-5"><a href="#cb269-5" aria-hidden="true" tabindex="-1"></a>nwalkers, ndim <span class="op">=</span> init.shape</span>
<span id="cb269-6"><a href="#cb269-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb269-7"><a href="#cb269-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb269-8"><a href="#cb269-8" aria-hidden="true" tabindex="-1"></a>sampler <span class="op">=</span> emcee.EnsembleSampler(</span>
<span id="cb269-9"><a href="#cb269-9" aria-hidden="true" tabindex="-1"></a>    nwalkers,</span>
<span id="cb269-10"><a href="#cb269-10" aria-hidden="true" tabindex="-1"></a>    ndim,</span>
<span id="cb269-11"><a href="#cb269-11" aria-hidden="true" tabindex="-1"></a>    logprob,</span>
<span id="cb269-12"><a href="#cb269-12" aria-hidden="true" tabindex="-1"></a>    moves<span class="op">=</span>[</span>
<span id="cb269-13"><a href="#cb269-13" aria-hidden="true" tabindex="-1"></a>        emcee.moves.GaussianMove(proposal_stddev)</span>
<span id="cb269-14"><a href="#cb269-14" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb269-15"><a href="#cb269-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb269-16"><a href="#cb269-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb269-17"><a href="#cb269-17" aria-hidden="true" tabindex="-1"></a>sampler.run_mcmc(init, <span class="dv">1000</span>, )</span>
<span id="cb269-18"><a href="#cb269-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb269-19"><a href="#cb269-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb269-20"><a href="#cb269-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Autocorrelation time: </span><span class="sc">{0:.2f}</span><span class="st"> steps"</span>.<span class="bu">format</span>(</span>
<span id="cb269-21"><a href="#cb269-21" aria-hidden="true" tabindex="-1"></a>        sampler.get_autocorr_time()[<span class="dv">0</span>]</span>
<span id="cb269-22"><a href="#cb269-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb269-23"><a href="#cb269-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb269-24"><a href="#cb269-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb269-25"><a href="#cb269-25" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb269-26"><a href="#cb269-26" aria-hidden="true" tabindex="-1"></a>plt.plot(sampler.get_chain()[burn_in_samples:, <span class="dv">0</span>, <span class="dv">0</span>], label <span class="op">=</span> <span class="st">'Samples obtained using emcee'</span>)</span>
<span id="cb269-27"><a href="#cb269-27" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"step number"</span>)</span>
<span id="cb269-28"><a href="#cb269-28" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"x"</span>)</span>
<span id="cb269-29"><a href="#cb269-29" aria-hidden="true" tabindex="-1"></a>plt.legend()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Autocorrelation time: 3.94 steps</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-125-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-22"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-125-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-166" class="cell" data-outputid="47329586-87aa-47da-fced-76b7f8a0dcfa">
<div class="sourceCode cell-code" id="cb271"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a>mean_emcee <span class="op">=</span> torch.tensor([np.mean(sampler.get_chain()[<span class="dv">500</span>:, <span class="dv">0</span>, <span class="dv">0</span>]),np.mean(sampler.get_chain()[<span class="dv">500</span>:, <span class="dv">1</span>, <span class="dv">0</span>])])</span>
<span id="cb271-2"><a href="#cb271-2" aria-hidden="true" tabindex="-1"></a>torch_emcee_samples <span class="op">=</span> torch.tensor([sampler.get_chain()[<span class="dv">500</span>:, <span class="dv">0</span>, <span class="dv">0</span>], sampler.get_chain()[<span class="dv">500</span>:, <span class="dv">1</span>, <span class="dv">0</span>]])</span>
<span id="cb271-3"><a href="#cb271-3" aria-hidden="true" tabindex="-1"></a>covariance_matrix_emcee <span class="op">=</span> torch.matmul((torch_emcee_samples.T <span class="op">-</span> mean_emcee).T, (torch_emcee_samples.T <span class="op">-</span> mean_emcee)) <span class="op">/</span> (torch_emcee_samples.T.size(<span class="dv">0</span>) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb271-4"><a href="#cb271-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-5"><a href="#cb271-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"RWMH Acceptance Rate(emcee implementation):"</span>, np.mean(sampler.acceptance_fraction))</span>
<span id="cb271-6"><a href="#cb271-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"RWMH Mean(emcee implementation):"</span>, mean_emcee)</span>
<span id="cb271-7"><a href="#cb271-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"RWMH Covariance Matrix(emcee implementation):"</span>, covariance_matrix_emcee)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RWMH Acceptance Rate(emcee implementation): 0.45899999999999996
RWMH Mean(emcee implementation): tensor([-0.0174, -0.0024], dtype=torch.float64)
RWMH Covariance Matrix(emcee implementation): tensor([[0.2241, 0.0122],
        [0.0122, 0.1906]], dtype=torch.float64)</code></pre>
</div>
</div>
<div id="cell-167" class="cell" data-outputid="04901ff1-a238-45d1-e4a6-00732a89a031">
<div class="sourceCode cell-code" id="cb273"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb273-1"><a href="#cb273-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the KDE of the burned samples</span></span>
<span id="cb273-2"><a href="#cb273-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb273-3"><a href="#cb273-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb273-4"><a href="#cb273-4" aria-hidden="true" tabindex="-1"></a><span class="co"># sns.kdeplot(burned_samples.numpy()[:, 0], shade=True, color="blue", label="KDE")</span></span>
<span id="cb273-5"><a href="#cb273-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-6"><a href="#cb273-6" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(sampler.get_chain()[<span class="dv">500</span>:, <span class="dv">0</span>, <span class="dv">0</span>], shade<span class="op">=</span><span class="va">True</span>, color<span class="op">=</span><span class="st">"red"</span>, label<span class="op">=</span><span class="st">"KDE of samples using emcee"</span>)</span>
<span id="cb273-7"><a href="#cb273-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-8"><a href="#cb273-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-9"><a href="#cb273-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-10"><a href="#cb273-10" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Parameter 1'</span>)</span>
<span id="cb273-11"><a href="#cb273-11" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Density'</span>)</span>
<span id="cb273-12"><a href="#cb273-12" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'KDESamples'</span>)</span>
<span id="cb273-13"><a href="#cb273-13" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb273-14"><a href="#cb273-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\Dell\AppData\Local\Temp\ipykernel_14380\699697460.py:6: FutureWarning: 

`shade` is now deprecated in favor of `fill`; setting `fill=True`.
This will become an error in seaborn v0.14.0; please update your code.

  sns.kdeplot(sampler.get_chain()[500:, 0, 0], shade=True, color="red", label="KDE of samples using emcee")</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-127-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-23"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-127-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-168" class="cell" data-outputid="79d6b0c2-7163-4f3a-8f4e-b982824bb223">
<div class="sourceCode cell-code" id="cb275"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb275-1"><a href="#cb275-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> hamiltorch</span>
<span id="cb275-2"><a href="#cb275-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb275-3"><a href="#cb275-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb275-4"><a href="#cb275-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial state</span></span>
<span id="cb275-5"><a href="#cb275-5" aria-hidden="true" tabindex="-1"></a>x0 <span class="op">=</span> torch.tensor([<span class="fl">0.0</span>,<span class="fl">0.0</span>])</span>
<span id="cb275-6"><a href="#cb275-6" aria-hidden="true" tabindex="-1"></a>num_samples <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb275-7"><a href="#cb275-7" aria-hidden="true" tabindex="-1"></a>step_size <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb275-8"><a href="#cb275-8" aria-hidden="true" tabindex="-1"></a>num_steps_per_sample <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb275-9"><a href="#cb275-9" aria-hidden="true" tabindex="-1"></a>hamiltorch.set_random_seed(<span class="dv">123</span>)</span>
<span id="cb275-10"><a href="#cb275-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb275-11"><a href="#cb275-11" aria-hidden="true" tabindex="-1"></a>params_hmc <span class="op">=</span> hamiltorch.sample(log_prob_func<span class="op">=</span>logprob_tensor, params_init<span class="op">=</span>x0,</span>
<span id="cb275-12"><a href="#cb275-12" aria-hidden="true" tabindex="-1"></a>                               num_samples<span class="op">=</span>num_samples, step_size<span class="op">=</span>step_size,</span>
<span id="cb275-13"><a href="#cb275-13" aria-hidden="true" tabindex="-1"></a>                               num_steps_per_sample<span class="op">=</span>num_steps_per_sample)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sampling (Sampler.HMC; Integrator.IMPLICIT)
Time spent  | Time remain.| Progress             | Samples   | Samples/sec
0d:00:00:01 | 0d:00:00:00 | #################### | 1000/1000 | 667.00         
Acceptance Rate 0.49</code></pre>
</div>
</div>
<div id="cell-169" class="cell" data-outputid="65017200-b487-491c-beb4-77f48addb5b2">
<div class="sourceCode cell-code" id="cb277"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb277-1"><a href="#cb277-1" aria-hidden="true" tabindex="-1"></a>params_hmc <span class="op">=</span> torch.stack(params_hmc)</span>
<span id="cb277-2"><a href="#cb277-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-3"><a href="#cb277-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-4"><a href="#cb277-4" aria-hidden="true" tabindex="-1"></a>mean_hamil <span class="op">=</span> params_hmc.mean(dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb277-5"><a href="#cb277-5" aria-hidden="true" tabindex="-1"></a>covariance_matrix_hamil <span class="op">=</span> torch.matmul((params_hmc <span class="op">-</span> mean_hamil).T, (params_hmc <span class="op">-</span> mean_hamil)) <span class="op">/</span> (params_hmc.size(<span class="dv">0</span>) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb277-6"><a href="#cb277-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-7"><a href="#cb277-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"RWMH Mean:"</span>, mean_hamil)</span>
<span id="cb277-8"><a href="#cb277-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"RWMH Covariance Matrix:"</span>, covariance_matrix_hamil)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RWMH Mean: tensor([-0.0168,  0.0195])
RWMH Covariance Matrix: tensor([[0.2350, 0.0216],
        [0.0216, 1.0323]])</code></pre>
</div>
</div>
<div id="cell-170" class="cell" data-outputid="f072283f-a696-4743-cc7f-0419c9961715">
<div class="sourceCode cell-code" id="cb279"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb279-1"><a href="#cb279-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the KDE of the burned samples</span></span>
<span id="cb279-2"><a href="#cb279-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb279-3"><a href="#cb279-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb279-4"><a href="#cb279-4" aria-hidden="true" tabindex="-1"></a><span class="co"># sns.kdeplot(burned_samples.numpy()[:, 0], shade=True, color="blue", label="KDE")</span></span>
<span id="cb279-5"><a href="#cb279-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-6"><a href="#cb279-6" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(params_hmc.numpy()[<span class="dv">500</span>:,<span class="dv">0</span>], fill<span class="op">=</span><span class="va">True</span>, color<span class="op">=</span><span class="st">'C1'</span>, label <span class="op">=</span> <span class="st">'Samples obtained using hamiltorch'</span>)</span>
<span id="cb279-7"><a href="#cb279-7" aria-hidden="true" tabindex="-1"></a>plt.axvline(mean_hamil[<span class="dv">0</span>], color<span class="op">=</span><span class="st">"red"</span>, label<span class="op">=</span><span class="st">"Mean of hamiltorch samples"</span>)</span>
<span id="cb279-8"><a href="#cb279-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-9"><a href="#cb279-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb279-10"><a href="#cb279-10" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Parameter 1'</span>)</span>
<span id="cb279-11"><a href="#cb279-11" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Density'</span>)</span>
<span id="cb279-12"><a href="#cb279-12" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'KDESamples'</span>)</span>
<span id="cb279-13"><a href="#cb279-13" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb279-14"><a href="#cb279-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-130-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-24"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-130-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<div id="cell-171" class="cell" data-outputid="b84a1e53-bde1-45e9-8ce1-2bccfd9cfb29">
<div class="sourceCode cell-code" id="cb280"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a><span class="co"># KDE plot</span></span>
<span id="cb280-2"><a href="#cb280-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb280-3"><a href="#cb280-3" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb280-4"><a href="#cb280-4" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(params_hmc.numpy()[<span class="dv">500</span>:,<span class="dv">0</span>], fill<span class="op">=</span><span class="va">True</span>, color<span class="op">=</span><span class="st">'C1'</span>, label <span class="op">=</span> <span class="st">'Samples obtained using hamiltorch'</span>)</span>
<span id="cb280-5"><a href="#cb280-5" aria-hidden="true" tabindex="-1"></a>plt.axvline(mean_hamil[<span class="dv">0</span>], color<span class="op">=</span><span class="st">"red"</span>, label<span class="op">=</span><span class="st">"Mean of hamiltorch samples"</span>)</span>
<span id="cb280-6"><a href="#cb280-6" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(sampler.get_chain()[<span class="dv">500</span>:, <span class="dv">0</span>, <span class="dv">0</span>], fill<span class="op">=</span><span class="va">True</span>, color<span class="op">=</span><span class="st">"red"</span>, label<span class="op">=</span><span class="st">"KDE of samples using emcee"</span>)</span>
<span id="cb280-7"><a href="#cb280-7" aria-hidden="true" tabindex="-1"></a>plt.axvline(mean_emcee[<span class="dv">0</span>], color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="st">"Mean of emcee samples"</span>)</span>
<span id="cb280-8"><a href="#cb280-8" aria-hidden="true" tabindex="-1"></a>sns.kdeplot(burned_samples.numpy()[:, <span class="dv">0</span>], fill<span class="op">=</span><span class="va">True</span>, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="st">"KDE of scratch algorithm"</span>)</span>
<span id="cb280-9"><a href="#cb280-9" aria-hidden="true" tabindex="-1"></a>plt.axvline(mean[<span class="dv">0</span>], color<span class="op">=</span><span class="st">"green"</span>, label<span class="op">=</span><span class="st">"Mean of scratch samples"</span>)</span>
<span id="cb280-10"><a href="#cb280-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb280-11"><a href="#cb280-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb280-12"><a href="#cb280-12" aria-hidden="true" tabindex="-1"></a><span class="co"># plt.plot(x_lin, y_lin, label='Ground truth')</span></span>
<span id="cb280-13"><a href="#cb280-13" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Parameter value'</span>)</span>
<span id="cb280-14"><a href="#cb280-14" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Density'</span>)</span>
<span id="cb280-15"><a href="#cb280-15" aria-hidden="true" tabindex="-1"></a>plt.legend()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-131-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-25"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-131-output-1.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>From the above distribution, we can see that our scratch implementation is similar to hamiltorch’s standard HMC and emcee’s Metropolis Hastings implementation.</p>
<div id="cell-174" class="cell" data-outputid="c390f133-fbdf-43dc-c1c4-ada233503763">
<div class="sourceCode cell-code" id="cb281"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb281-1"><a href="#cb281-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb281-2"><a href="#cb281-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpy.linalg <span class="im">import</span> norm</span>
<span id="cb281-3"><a href="#cb281-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-4"><a href="#cb281-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Assuming cov1 and cov2 are your covariance matrices</span></span>
<span id="cb281-5"><a href="#cb281-5" aria-hidden="true" tabindex="-1"></a>frobenius_norm <span class="op">=</span> norm(covariance_matrix_hamil<span class="op">-</span> covariance_matrix_emcee, <span class="st">'fro'</span>)</span>
<span id="cb281-6"><a href="#cb281-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Frobenius norm for hamiltorch and emcee:"</span>, frobenius_norm)</span>
<span id="cb281-7"><a href="#cb281-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-8"><a href="#cb281-8" aria-hidden="true" tabindex="-1"></a>frobenius_norm <span class="op">=</span> norm(covariance_matrix_hamil<span class="op">-</span> covariance_matrix, <span class="st">'fro'</span>)</span>
<span id="cb281-9"><a href="#cb281-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Frobenius norm for hamiltorch and scratch:"</span>, frobenius_norm)</span>
<span id="cb281-10"><a href="#cb281-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-11"><a href="#cb281-11" aria-hidden="true" tabindex="-1"></a>frobenius_norm <span class="op">=</span> norm(covariance_matrix_emcee<span class="op">-</span> covariance_matrix, <span class="st">'fro'</span>)</span>
<span id="cb281-12"><a href="#cb281-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Frobenius norm for emcee and scratch:"</span>, frobenius_norm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Frobenius norm for hamiltorch and emcee: 0.8417977279587513
Frobenius norm for hamiltorch and scratch: 0.24498351
Frobenius norm for emcee and scratch: 0.6288880822849502</code></pre>
</div>
</div>
<div id="cell-175" class="cell" data-outputid="92a7000f-d410-48ac-e113-c11aa8646a1b">
<div class="sourceCode cell-code" id="cb283"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb283-1"><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb283-2"><a href="#cb283-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-3"><a href="#cb283-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a sample covariance matrix (replace this with your own data)</span></span>
<span id="cb283-4"><a href="#cb283-4" aria-hidden="true" tabindex="-1"></a>cov_matrix <span class="op">=</span> np.array([[<span class="dv">0</span>, <span class="dv">0</span>], [<span class="fl">0.5</span>, <span class="fl">1.0</span>]])</span>
<span id="cb283-5"><a href="#cb283-5" aria-hidden="true" tabindex="-1"></a>cov_matrices <span class="op">=</span> [cov_matrix, covariance_matrix, covariance_matrix_emcee, covariance_matrix_hamil]</span>
<span id="cb283-6"><a href="#cb283-6" aria-hidden="true" tabindex="-1"></a>plt_titles <span class="op">=</span> [<span class="st">'Ground Truth'</span>, <span class="st">'Scratch'</span>, <span class="st">'emcee'</span>, <span class="st">'hamiltorch'</span>]</span>
<span id="cb283-7"><a href="#cb283-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-8"><a href="#cb283-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a list of colors for the colorbar</span></span>
<span id="cb283-9"><a href="#cb283-9" aria-hidden="true" tabindex="-1"></a>cmap <span class="op">=</span> plt.get_cmap(<span class="st">"viridis"</span>)</span>
<span id="cb283-10"><a href="#cb283-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-11"><a href="#cb283-11" aria-hidden="true" tabindex="-1"></a>fig, axn <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, sharex<span class="op">=</span><span class="va">True</span>, sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb283-12"><a href="#cb283-12" aria-hidden="true" tabindex="-1"></a>cbar_ax <span class="op">=</span> fig.add_axes([<span class="fl">.91</span>, <span class="fl">.3</span>, <span class="fl">.03</span>, <span class="fl">.4</span>])</span>
<span id="cb283-13"><a href="#cb283-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-14"><a href="#cb283-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, ax <span class="kw">in</span> <span class="bu">enumerate</span>(axn.flat):</span>
<span id="cb283-15"><a href="#cb283-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Specify color and other properties of the colorbar</span></span>
<span id="cb283-16"><a href="#cb283-16" aria-hidden="true" tabindex="-1"></a>    cbar_kws <span class="op">=</span> {</span>
<span id="cb283-17"><a href="#cb283-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"orientation"</span>: <span class="st">"vertical"</span>,</span>
<span id="cb283-18"><a href="#cb283-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"label"</span>: <span class="st">"Colorbar Label"</span>,</span>
<span id="cb283-19"><a href="#cb283-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cmap"</span>: cmap,</span>
<span id="cb283-20"><a href="#cb283-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb283-21"><a href="#cb283-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-22"><a href="#cb283-22" aria-hidden="true" tabindex="-1"></a>    sns.heatmap(cov_matrices[i], ax<span class="op">=</span>ax,</span>
<span id="cb283-23"><a href="#cb283-23" aria-hidden="true" tabindex="-1"></a>                cbar<span class="op">=</span>i <span class="op">==</span> <span class="dv">0</span>,</span>
<span id="cb283-24"><a href="#cb283-24" aria-hidden="true" tabindex="-1"></a>                vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb283-25"><a href="#cb283-25" aria-hidden="true" tabindex="-1"></a>                cbar_ax<span class="op">=</span><span class="va">None</span> <span class="cf">if</span> i <span class="cf">else</span> cbar_ax,</span>
<span id="cb283-26"><a href="#cb283-26" aria-hidden="true" tabindex="-1"></a>                cmap <span class="op">=</span> <span class="st">"coolwarm"</span>,annot<span class="op">=</span><span class="va">True</span>)  <span class="co"># Pass cbar_kws</span></span>
<span id="cb283-27"><a href="#cb283-27" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f'</span><span class="sc">{</span>plt_titles[i]<span class="sc">}</span><span class="ss">'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb283-28"><a href="#cb283-28" aria-hidden="true" tabindex="-1"></a>fig.tight_layout(rect<span class="op">=</span>[<span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">.9</span>, <span class="dv">1</span>])</span>
<span id="cb283-29"><a href="#cb283-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-30"><a href="#cb283-30" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\Dell\AppData\Local\Temp\ipykernel_14380\989267052.py:28: UserWarning: This figure includes Axes that are not compatible with tight_layout, so results might be incorrect.
  fig.tight_layout(rect=[0, 0, .9, 1])</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="PML_assign4_Suraj_Aditi_files/figure-html/cell-133-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-26"><img src="PML_assign4_Suraj_Aditi_files/figure-html/cell-133-output-2.png" class="img-fluid figure-img"></a></p>
</figure>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/jaiswalsuraj487\.github\.io\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>